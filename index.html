<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××ª×›×•× ×™× ××©×¤×—×ª×™×™×</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f7f9f7;     
            --primary: #408067;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --tag-bg: #e4f0eb;       
            --tag-text: #1d4a38;     
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent; /* Remove mobile tap highlight */
        }

        .container { max-width: 900px; margin: 0 auto; }

        /* Header */
        .site-header { text-align: center; margin-bottom: 2rem; }
        .search-box {
            width: 100%; max-width: 500px; padding: 15px;
            font-size: 1.1rem; border: 2px solid #ddd; border-radius: 50px;
            font-family: inherit; margin-bottom: 1rem;
        }
        
        .tags-cloud { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        
        .tag-btn {
            background: #fff; border: 1px solid #ddd; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
            font-family: inherit; font-size: 1rem;
        }
        .tag-btn:hover { background: #eee; }
        .tag-btn.active-tag {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Grid & Cards */
        .recipe-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px;
        }
        .card {
            background: var(--card-bg); border-radius: 16px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer;
            border: 1px solid #f0f0f0; transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-5px); }
        .card:focus { outline: 3px solid var(--primary); transform: translateY(-5px); } /* Keyboard focus style */
        .card img { width: 100%; height: 200px; object-fit: cover; display: block; }
        .card-content { padding: 1.5rem; }
        .card h2 { margin: 0 0 0.5rem 0; font-size: 1.3rem; }
        
        .badge { 
            background: var(--tag-bg); 
            color: var(--tag-text); 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 0.8rem; 
            margin-left: 5px; 
        }

        /* Recipe Detail */
        .recipe-detail { background: white; padding: 2rem; border-radius: 20px; position: relative; }
        .english-content { direction: ltr; text-align: left; font-family: sans-serif; }

        .recipe-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap; 
            gap: 10px;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            align-items: center;
        }
        
        .action-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #555;
            transition: all 0.2s;
            position: relative;
            font-family: inherit;
        }
        
        .action-btn:hover {
            background: #f8f9fa;
            border-color: #bbb;
            color: #333;
        }

        .icon-svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .action-btn.active {
            background: #e4f0eb;
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Tooltip Logic */
        .action-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 6px 10px;
            background: #333;
            color: white;
            font-size: 0.75rem;
            border-radius: 6px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
            z-index: 10;
        }
        
        .action-btn[data-tooltip]:hover::before {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 3px;
            border: 5px solid transparent;
            border-top-color: #333;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
        }

        /* Language Toggle */
        .lang-toggle {
            display: flex;
            background: #eee;
            border-radius: 20px;
            padding: 2px;
            margin: 0 10px;
        }
        .lang-btn {
            border: none;
            background: none;
            padding: 5px 15px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 0.85rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        .lang-btn.active {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: bold;
            color: var(--primary);
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .scaler {
            background: #f8f9fa; padding: 15px; border-radius: 12px;
            margin: 20px 0; display: inline-flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        .scale-btn {
            background: white; border: 1px solid #ddd; padding: 5px 15px;
            border-radius: 6px; cursor: pointer;
        }
        .scale-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .ingredients-list { max-width: 600px; }
        .ingredients-list ul { padding: 0; list-style: none; }
        .ingredients-list li {
            padding: 10px 0; display: flex; align-items: baseline; gap: 12px;
            border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: opacity 0.2s;
        }
        .ingredients-list li::before {
            content: ""; display: inline-block; width: 16px; height: 16px;
            border: 2px solid #dcdcdc; border-radius: 4px; background-color: transparent;
            margin-left: 8px; flex-shrink: 0; position: relative; top: 3px; transition: all 0.2s;
        }
        .ingredients-list li.checked { opacity: 0.5; }
        .ingredients-list li.checked .ing-content { text-decoration: line-through; text-decoration-thickness: 1px; }
        .ingredients-list li.checked::before { background-color: var(--primary); border-color: var(--primary); }
        .ingredients-list li span { font-weight: 400; color: #444; }
        .auto-conversion { font-size: 0.85em; color: #888; font-weight: normal; }
        .ingredients-list li strong { color: inherit; font-weight: 400; white-space: nowrap; }

        .ing-section-title { color: var(--primary); border-bottom: 2px solid var(--primary); display: inline-block; margin-top: 1.5rem; }

        .instructions { font-size: 1.05rem; line-height: 1.8; color: #2d3436; }
        .instructions ol, .instructions ul { padding-right: 1.5rem; margin: 0.5rem 0 1.5rem 0; }
        .instructions li { margin-bottom: 0.8rem; padding-left: 0.5rem; }
        .instructions p { margin-bottom: 1rem; }
        .instructions u { text-decoration: underline; text-decoration-color: var(--primary); text-decoration-thickness: 2px; text-underline-offset: 3px; }
        .instructions b, .instructions strong { font-weight: 700; color: #000; }

        /* Footer & Modal */
        .footer-section { margin-top: 50px; padding: 30px; background: #2d3436; color: white; border-radius: 20px; text-align: center; }
        .draft-form input, .draft-form textarea { width: 90%; padding: 10px; margin: 10px 0; border-radius: 8px; border: none; font-family: inherit; }
        .draft-checkboxes { display: flex; gap: 15px; justify-content: center; margin: 10px 0; }
        .admin-link { color: #888; text-decoration: none; font-size: 0.8rem; margin: 20px 10px 0 10px; display: inline-flex; align-items: center; gap: 5px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 15px; left: 15px; font-size: 1.5rem; cursor: pointer; background: none; border: none; }
        .gen-input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;}
        .gen-tags-container { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .gen-tag-check { display: flex; align-items: center; gap: 5px; background: #f8f9fa; padding: 5px 10px; border-radius: 15px; border: 1px solid #ddd;}
        .ing-row { display: grid; grid-template-columns: 0.5fr 0.5fr 2fr auto; gap: 5px; margin-bottom: 5px; align-items: center; }
        .row-controls { display: flex; gap: 5px; }
        .remove-row-btn { background: #ff7675; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 5px 10px; }
        .move-btn { background: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; padding: 5px 10px; font-weight: bold; color: #555; }
        .add-row-btn { background: #55efc4; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-bottom: 15px; display: block; }
        .code-output { width: 100%; height: 150px; background: #333; color: #0f0; font-family: monospace; direction: ltr; text-align: left; padding: 10px; margin-top: 10px; }
        .section-row { margin-top: 15px; margin-bottom: 5px; display: flex; gap: 5px; align-items: center; }
        .gen-section-name { flex: 1; font-weight: bold; color: var(--primary); border: 2px solid var(--primary); background: #b9c4ba; padding: 8px; border-radius: 4px; margin: 0; }
        .add-btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .editor-toolbar { display: flex; gap: 5px; margin-bottom: 5px; }
        .toolbar-btn { background: #f1f2f6; border: 1px solid #ddd; border-radius: 4px; padding: 2px 10px; cursor: pointer; font-weight: bold; font-family: monospace; }
        
        /* Optimizer Styles */
        .optimizer-box { background: #f0f8ff; border: 2px dashed #a0cfee; padding: 20px; border-radius: 10px; margin-top: 30px; }
        .optimizer-box h3 { margin-top: 0; color: #2980b9; }

        /* --- PRINT MODE --- */
        @media print {
            .site-header, .footer-section, .tag-btn, .action-bar, .scaler { display: none !important; }
            body { background: white; color: black; padding: 0; }
            .recipe-detail { padding: 0; box-shadow: none; border: none; }
            .container { max-width: 100%; width: 100%; margin: 0; }
            .card { break-inside: avoid; border: 1px solid #ddd; }
            img { display: none; }
            .instructions { font-size: 12pt; }
            h1 { font-size: 18pt; margin-bottom: 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header class="site-header">
        <h1 style="cursor: pointer;" onclick="navigateHome()">
    ××ª×›×•× ×™× ××©×¤×—×ª×™×™× 
    </h1>
        <input type="text" class="search-box" placeholder="×—×™×¤×•×© ××ª×›×•×Ÿ, ×›×•×ª×‘, ×ª×’×™×ª, ××• ××¨×›×™×‘..." onkeyup="searchRecipes(this.value)">
        <div class="tags-cloud" id="header-tags"></div>
    </header>

    <main id="app"></main>

    <div class="footer-section">
        <h3>×—×¡×¨ ××ª×›×•×Ÿ?</h3>
        <p>××œ××• ××ª ×”×¤×¨×˜×™× ×•×©×œ×—×• ××œ×™×™ ×œ××™×™×œ</p>
        <div class="draft-form">
            <input type="text" id="draft-title" placeholder="×©× ×”×× ×”">
            <div class="draft-checkboxes" id="draft-tags-container"></div>
            <textarea id="draft-body" rows="3" placeholder="×¨×©×™××ª ××¦×¨×›×™× ×•×”×•×¨××•×ª..."></textarea>
            
            <button class="tag-btn" style="background:var(--primary); color:white; border:none; width: 100%; justify-content: center;" onclick="sendDraft()">
                ×©×œ×™×—×” ×œ××™×™×œ
                <svg class="icon-svg" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
        
        <a href="#" onclick="toggleModal(true); return false;" class="admin-link">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
            ××—×•×œ×œ ××ª×›×•× ×™×
        </a>
        
        <a href="#" onclick="loadRecipeToEdit(); return false;" class="admin-link" id="edit-json-link" style="display: none;">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            ×¢×¨×™×›×”
        </a>
    </div>
</div>

<div id="adminModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="toggleModal(false)">âœ–</button>
        
        <h2>××—×•×œ×œ ××ª×›×•× ×™×</h2>
        <input type="text" id="gen-id" class="gen-input" placeholder="ID (×× ×’×œ×™×ª, ×‘×œ×™ ×¨×•×•×—×™×)">
        <input type="text" id="gen-title" class="gen-input" placeholder="×©× ×”××ª×›×•×Ÿ">
        <input type="text" id="gen-author" class="gen-input" placeholder="×™×•×¦×¨">
        <label>×ª×’×™×•×ª:</label>
        <div id="gen-tags-container" class="gen-tags-container"></div>
        <input type="text" id="gen-image" class="gen-input" placeholder="×©× ×§×•×‘×¥ ×ª××•× ×” (×œ××©×œ cake.jpg) - ×œ×”×©××™×¨ ×¨×™×§ ×× ××™×Ÿ">
        <input type="text" id="gen-url" class="gen-input" placeholder="×§×™×©×•×¨ ×œ××§×•×¨ (××•×¤×¦×™×•× ×œ×™)">
        <label>××¦×¨×›×™×:</label>
        <div style="font-size: 0.8rem; color:#888; margin-bottom:5px; display:grid; grid-template-columns: 0.5fr 0.5fr 2fr auto; gap:5px; padding-right: 8px;">
            <span>×›××•×ª</span><span>×™×—×™×“×”</span><span>××•×¦×¨</span><span></span>
        </div>
        <div id="gen-ing-rows"></div>
        <div class="add-btn-group">
            <button onclick="addIngRow()" class="add-row-btn" style="flex:2; background:#e4f0eb;">+ ×”×•×¡×£ ××¦×¨×š</button>
            <button onclick="addSectionRow()" class="add-row-btn" style="flex:1; background:#e4f0eb;">+ ×”×•×¡×£ ×›×•×ª×¨×ª</button>
        </div>
        <label>×”×•×¨××•×ª ×”×›× ×”:</label>
        <div class="editor-toolbar">
            <button class="toolbar-btn" onclick="wrapText('b')" title="×”×“×’×©×”">B</button>
            <button class="toolbar-btn" onclick="wrapText('u')" title="×§×• ×ª×—×ª×•×Ÿ" style="text-decoration:underline;">U</button>
        </div>
        <textarea id="gen-inst" rows="5" class="gen-input"></textarea>
        <button class="tag-btn" style="background:var(--primary); color:white; width:100%; justify-content:center;" onclick="generateCode()">×¦×•×¨ ×§×•×“</button>
        <textarea id="gen-output" class="code-output" placeholder=""></textarea>

        <!-- OPTIMIZER TOOL -->
        <div class="optimizer-box">
            <h3>×›×œ×™ ×œ×›×™×•×•×¥ ×ª××•× ×•×ª (Optimizer)</h3>
            <p style="font-size:0.9rem;">
                ×‘×—×¨ ××ª ×§×•×‘×¥ ×”×ª××•× ×” ×”×’×“×•×œ ××”××—×©×‘ ×©×œ×š. ×”×›×œ×™ ×™×•×¨×™×“ ××™×™×“×™×ª ×’×¨×¡×” ××•×§×˜× ×ª (thumbnail).
                <br>
                ×”×¢×ª×§ ××ª ×”×§×•×‘×¥ ×”×—×“×© ×œ×ª×™×§×™×™×ª <code>images</code> ×©×œ×š.
            </p>
            
            <input type="file" id="opt-files" multiple accept="image/*" class="gen-input">
            <button class="tag-btn" style="background:#2980b9; color:white; width:100%; justify-content:center;" onclick="processImages()">
                ×¦×•×¨ ×ª××•× ×” ××•×§×˜× ×ª
            </button>
            <div id="opt-status" style="margin-top:10px; font-size:0.9rem;"></div>
        </div>

    </div>
</div>

<script src="recipes.js"></script>
<script src="conversions.js"></script>

<script>
    // --- CONFIGURATION ---
    const DEFAULT_IMAGE = "images/no_image.jpg";
    const AVAILABLE_TAGS = ["×—×œ×‘×™", "×¦××—×•× ×™", "×‘×©×¨×™", "×§×™× ×•×—×™×", "×¢×•×’×•×ª", "×¡×œ×˜×™×", "English"];
    let wakeLock = null; 
    let currentRecipe = null;
    let currentLang = 'he';
    let activeTags = new Set(); // Changed from single string to Set for multi-select

    // --- INITIALIZATION ---
    const headerTags = document.getElementById('header-tags');
    // Initialize "All" button
    let tagsHTML = `<button class="tag-btn active-tag" id="tag-all" onclick="filterByTag('')">×”×›×œ</button>`;
    
    // Initialize other tags
    tagsHTML += AVAILABLE_TAGS.map(t => `<button class="tag-btn" id="tag-${t}" onclick="filterByTag('${t}')">${t}</button>`).join('');
    headerTags.innerHTML = tagsHTML;

    const draftTags = document.getElementById('draft-tags-container');
    draftTags.innerHTML = AVAILABLE_TAGS.filter(t=>t!=='English').map(t => `<label><input type="checkbox" value="${t}" class="draft-tag"> ${t}</label>`).join('');

    const genTags = document.getElementById('gen-tags-container');
    genTags.innerHTML = AVAILABLE_TAGS.map(t => `
        <label class="gen-tag-check">
            <input type="checkbox" value="${t}" class="gen-tag-input"> ${t}
        </label>`).join('');

    const app = document.getElementById('app');

    // --- HISTORY / NAVIGATION LOGIC ---
    window.addEventListener('load', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('recipe');
        if (recipeId) showRecipe(recipeId, false);
        else showList(recipes, false);
    });

    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.recipeId) {
            showRecipe(event.state.recipeId, false);
        } else {
            // Reset filters when going back to list
            activeTags.clear();
            updateFilterUI();
            showList(recipes, false);
        }
    });

    function navigateToRecipe(id) { showRecipe(id, true); }
    function navigateHome() { 
        // Reset filters when clicking Home/Back
        activeTags.clear();
        updateFilterUI();
        showList(recipes, true); 
    }

    // --- MAIN LIST LOGIC ---
    function showList(data, pushState = true) {
        // HIDE Edit Button in list view
        document.getElementById('edit-json-link').style.display = 'none';

        if (!data || !data.length) { app.innerHTML = '<p>×œ× × ××¦××• ×ª×•×¦××•×ª</p>'; return; }
        
        if (pushState) {
            history.pushState({}, '', window.location.pathname);
            document.title = "××ª×›×•× ×™× ××©×¤×—×ª×™×™×";
        }

        const isEnglishMode = activeTags.has('English');

        let html = '<div class="recipe-grid">';
        data.forEach(r => {
            const imgSrc = r.image ? r.image : DEFAULT_IMAGE;
            // Generate thumb path: images/cake.jpg -> images/cake_thumb.jpg
            let thumbSrc = imgSrc;
            if (imgSrc !== DEFAULT_IMAGE && !imgSrc.startsWith('http')) {
                const parts = imgSrc.split('.');
                const ext = parts.pop();
                thumbSrc = parts.join('.') + '_thumb.' + ext;
            }

            // If English tag is active, use English title if available
            const displayTitle = (isEnglishMode && r.english) ? r.english.title : r.title;
            const displayAuthor = (isEnglishMode && r.english) ? r.english.author : r.author;

            // Accessibility: tabindex="0" and keyboard handler
            html += `
                <div class="card" 
                     tabindex="0"
                     onclick="navigateToRecipe('${r.id}')"
                     onkeypress="if(event.key === 'Enter') navigateToRecipe('${r.id}')">
                     
                    <img src="${thumbSrc}" 
                         alt="${displayTitle}" 
                         loading="lazy" 
                         decoding="async"
                         onerror="this.onerror=null; this.src='${imgSrc}'">
                    <div class="card-content">
                        <h2>${displayTitle}</h2>
                        <p class="author">×××ª: ${displayAuthor}</p>
                        <div>${r.tags.map(t => `<span class="badge">${t}</span>`).join('')}</div>
                    </div>
                </div>`;
        });
        html += '</div>';
        app.innerHTML = html;
        window.scrollTo(0,0);
        releaseWakeLock();
    }

    function showRecipe(id, pushState = true) {
        const r = recipes.find(x => x.id === id);
        if (!r) return;
        currentRecipe = r;
        
        // Auto-switch to English if the English tag filter is active
        currentLang = activeTags.has('English') ? 'en' : 'he';
        
        if (pushState) {
            history.pushState({ recipeId: id }, '', `?recipe=${id}`);
            document.title = `${r.title} | ××ª×›×•× ×™× ××©×¤×—×ª×™×™×`;
        }
        renderRecipeDetail();
        window.scrollTo(0,0);
    }

    function toggleLang(lang) {
        currentLang = lang;
        renderRecipeDetail();
    }

    function renderRecipeDetail() {
        // SHOW Edit Button in recipe view
        document.getElementById('edit-json-link').style.display = 'inline-flex';

        const r = currentRecipe;
        const isEn = currentLang === 'en';
        const data = isEn && r.english ? r.english : r;
        
        const imgSrc = r.image ? r.image : DEFAULT_IMAGE;
        let linkHTML = r.sourceUrl ? `<div style="margin:10px 0;"><a href="${r.sourceUrl}" target="_blank" style="color:blue; font-weight:bold;">ğŸ”— ${isEn ? 'Link to original' : '×œ××¢×‘×¨ ×œ××ª×›×•×Ÿ ×”××§×•×¨×™'}</a></div>` : '';

        // Share & WakeLock Buttons
        const shareBtn = navigator.share 
            ? `<button class="action-btn" onclick="shareRecipe()">
                 <svg class="icon-svg" viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                 ${isEn ? 'Share' : '×©×™×ª×•×£'}
               </button>`
            : '';

        const wakeLockBtn = `
            <button class="action-btn" id="wakeLockBtn" onclick="toggleWakeLock()" data-tooltip="${isEn ? 'Prevent screen from sleeping' : '××•× ×¢ ××”××¡×š ×œ×”×™×›×‘×•×ª ×‘×–××Ÿ ×”×‘×™×©×•×œ'}">
                ${isEn ? 'Wake Lock' : '××¡×š ×¤×¢×™×œ'}
            </button>`;
        
        // Language Toggle
        const langToggle = r.tags.includes('English') ? `
            <div class="lang-toggle">
                <button class="lang-btn ${!isEn ? 'active' : ''}" onclick="toggleLang('he')">×¢×‘×¨×™×ª</button>
                <button class="lang-btn ${isEn ? 'active' : ''}" onclick="toggleLang('en')">English</button>
            </div>` : '';

        app.innerHTML = `
            <div class="recipe-detail ${isEn ? 'english-content' : ''}">
                <div class="recipe-nav">
                    <button class="tag-btn" onclick="navigateHome()">
                        <svg class="icon-svg" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 19 12 12 5"></polyline></svg>
                        ${isEn ? 'Back' : '×—×–×¨×”'}
                    </button>
                    
                    ${langToggle}

                    <div class="action-bar">
                        ${shareBtn}
                        ${wakeLockBtn}
                    </div>
                </div>

                <img src="${imgSrc}" style="width:100%; height:300px; object-fit:cover; border-radius:12px; margin-top:10px;">
                <h1 style="text-align:center">${data.title}</h1>
                <p style="text-align:center">${isEn ? 'By' : '×××ª'}: ${data.author}</p>
                ${linkHTML}
                
                ${data.ingredients && data.ingredients.length > 0 ? `
                <div class="scaler">
                    <b>${isEn ? 'Scale' : '×›××•×™×•×ª'}:</b>
                    <button class="scale-btn" id="btn-0.5" onclick="renderIngredients(0.5)">0.5x</button>
                    <button class="scale-btn active" id="btn-1" onclick="renderIngredients(1)">1x</button>
                    <button class="scale-btn" id="btn-1.5" onclick="renderIngredients(1.5)">1.5x</button>
                    <button class="scale-btn" id="btn-2" onclick="renderIngredients(2)">2x</button>
                </div>
                <div id="ing-list" class="ingredients-list"></div>
                ` : ''}
                
                <h3>${isEn ? 'Instructions' : '×”×•×¨××•×ª'}:</h3>
                <div class="instructions">${formatInstructions(data.instructions)}</div>
            </div>
        `;
        
        // Re-attach wake lock active class if needed
        if(wakeLock && document.getElementById('wakeLockBtn')) {
             document.getElementById('wakeLockBtn').classList.add('active');
        }

        if(data.ingredients && data.ingredients.length > 0) renderIngredients(1);
    }

    // --- WAKE LOCK LOGIC ---
    async function toggleWakeLock() {
        const btn = document.getElementById('wakeLockBtn');
        if (!wakeLock) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => {
                    wakeLock = null;
                    if(document.getElementById('wakeLockBtn')) {
                        document.getElementById('wakeLockBtn').classList.remove('active');
                    }
                });
                if(btn) btn.classList.add('active');
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
                alert("×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘××¤×©×¨×•×ª ×–×•");
            }
        } else {
            await wakeLock.release();
            wakeLock = null;
            if(btn) btn.classList.remove('active');
        }
    }

    function releaseWakeLock() {
        if (wakeLock) {
            wakeLock.release();
            wakeLock = null;
        }
    }
    
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') {
            await toggleWakeLock();
        }
    });

    // --- SHARE LOGIC ---
    async function shareRecipe() {
        if (!currentRecipe) return;
        try {
            await navigator.share({
                title: currentRecipe.title,
                text: `${currentRecipe.title} - ${currentRecipe.author}`,
                url: window.location.href
            });
        } catch (err) {
            console.log("Share canceled");
        }
    }

    // --- EXISTING HELPER FUNCTIONS ---
    function formatInstructions(text) {
        if (!text) return '';
        const lines = text.split('\n').filter(line => line.trim() !== '');
        let html = '';
        let listType = null;
        lines.forEach(line => {
            line = line.trim();
            const orderedMatch = line.match(/^(\d+)[\.\)\-]\s+(.*)/);
            const unorderedMatch = line.match(/^[\-\*]\s+(.*)/);
            if (orderedMatch) {
                if (listType !== 'ol') { if (listType) html += `</${listType}>`; html += '<ol>'; listType = 'ol'; }
                html += `<li>${orderedMatch[2]}</li>`; 
            } else if (unorderedMatch) {
                if (listType !== 'ul') { if (listType) html += `</${listType}>`; html += '<ul>'; listType = 'ul'; }
                html += `<li>${unorderedMatch[1]}</li>`;
            } else {
                if (listType) { html += `</${listType}>`; listType = null; }
                html += `<p>${line}</p>`;
            }
        });
        if (listType) html += `</${listType}>`;
        return html;
    }

    function formatAmount(amount) {
        if (typeof amount !== 'number') return amount;
        if (Number.isInteger(amount)) return amount;
        const epsilon = 0.05; 
        const decimal = amount % 1;
        const integer = Math.floor(amount);
        let fraction = '';
        if (Math.abs(decimal - 0.25) < epsilon) fraction = '1/4';
        else if (Math.abs(decimal - 0.33) < epsilon) fraction = '1/3';
        else if (Math.abs(decimal - 0.5) < epsilon) fraction = '1/2';
        else if (Math.abs(decimal - 0.66) < epsilon) fraction = '2/3';
        else if (Math.abs(decimal - 0.75) < epsilon) fraction = '3/4';
        if (fraction) return integer > 0 ? `${integer} ${fraction}` : fraction;
        return amount.toFixed(2).replace(/\.?0+$/, '');
    }

    function renderIngredients(mult) {
        document.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btn-${mult}`);
        if(btn) btn.classList.add('active');

        const isEn = currentLang === 'en';
        const data = isEn && currentRecipe.english ? currentRecipe.english : currentRecipe;
        
        let html = '<ul>';
        const processItems = (items) => {
            return items.map(item => {
                let rawVal = item.amount ? (item.amount * mult) : '';
                let displayVal = rawVal;
                let conversionText = '';
                if (typeof rawVal === 'number') {
                    // Pass lang to conversion function
                    const conv = getConversion(rawVal, item.unit, item.item, isEn ? 'en' : 'he');
                    if (conv) conversionText = `<span class="auto-conversion">(${conv})</span>`;
                    displayVal = formatAmount(rawVal);
                }
                const shouldShowBold = (displayVal !== '') || (item.unit && item.unit.trim().length > 0);
                const amountHTML = shouldShowBold 
                    ? `<strong><span style="direction:ltr; unicode-bidi:embed;">${displayVal}</span> ${item.unit || ''}</strong> `
                    : '';
                return `<li onclick="this.classList.toggle('checked')">
                    <span class="ing-content">
                        ${amountHTML}<span>${item.item} ${conversionText}</span>
                    </span>
                </li>`;
            }).join('');
        };
        data.ingredients.forEach(entry => {
            if (entry.sectionName) { html += `</ul><h4 class="ing-section-title">${entry.sectionName}</h4><ul>`; html += processItems(entry.items); } 
            else if (entry.amount !== undefined) { html += processItems([entry]); }
        });
        html += '</ul>';
        document.getElementById('ing-list').innerHTML = html;
    }

    // --- SEARCH & FILTER LOGIC (UPDATED FOR MULTI-TAG) ---

    function filterByTag(tag) {
        if (tag === '') {
            // "All" clicked - clear everything
            activeTags.clear();
        } else {
            // Toggle specific tag
            if (activeTags.has(tag)) {
                activeTags.delete(tag);
            } else {
                activeTags.add(tag);
            }
        }
        
        updateFilterUI();
        runFilterAndShow();
    }

    function updateFilterUI() {
        // Update visual button states
        document.querySelectorAll('.tag-btn').forEach(btn => {
            const btnId = btn.id;
            if (btnId === 'tag-all') {
                if (activeTags.size === 0) btn.classList.add('active-tag');
                else btn.classList.remove('active-tag');
            } else {
                const tagName = btnId.replace('tag-', '');
                if (activeTags.has(tagName)) btn.classList.add('active-tag');
                else btn.classList.remove('active-tag');
            }
        });

        // Update search box style based on "English" tag
        const searchBox = document.querySelector('.search-box');
        if (activeTags.has('English')) {
            searchBox.placeholder = "Search for a recipe, author, tag, or ingredient...";
            searchBox.style.direction = "ltr";
        } else {
            searchBox.placeholder = "×—×™×¤×•×© ××ª×›×•×Ÿ, ×›×•×ª×‘, ×ª×’×™×ª, ××• ××¨×›×™×‘...";
            searchBox.style.direction = "rtl";
        }
    }

    function searchRecipes(q) {
        // We pass the query to the main filter function
        runFilterAndShow(q);
    }

    function runFilterAndShow(searchTerm = '') {
        // Combine Tag Filter + Search Term
        const term = searchTerm.toLowerCase();
        const isEnglishMode = activeTags.has('English');

        const filtered = recipes.filter(r => {
            // 1. Tag Filtering (Intersection: MUST have ALL selected tags)
            // If activeTags is empty, pass this check.
            if (activeTags.size > 0) {
                for (let tag of activeTags) {
                    if (!r.tags.includes(tag)) return false;
                }
            }

            // 2. Search Term Filtering
            if (term === '') return true; // No search term, keep it.

            if (isEnglishMode) {
                if (!r.english) return false;
                const title = r.english.title ? r.english.title.toLowerCase() : '';
                const author = r.english.author ? r.english.author.toLowerCase() : '';
                const ing = r.english.ingredients.some(entry => {
                    if (entry.items) return entry.items.some(sub => sub.item.toLowerCase().includes(term));
                    return entry.item && entry.item.toLowerCase().includes(term);
                });
                return title.includes(term) || author.includes(term) || ing;
            } else {
                // Hebrew search
                const inTitle = r.title.toLowerCase().includes(term);
                const inTags = r.tags.some(t => t.includes(term));
                const inAuthor = r.author && r.author.toLowerCase().includes(term);
                const inIngredients = r.ingredients.some(entry => {
                    if (entry.items) return entry.items.some(sub => sub.item.includes(term));
                    return entry.item && entry.item.includes(term);
                });
                return inTitle || inTags || inIngredients || inAuthor;
            }
        });

        showList(filtered, false);
    }

    function sendDraft() {
        const t = document.getElementById('draft-title').value;
        const b = document.getElementById('draft-body').value;
        const selectedTags = Array.from(document.querySelectorAll('.draft-tag:checked')).map(cb => cb.value).join(', ');
        const subject = `××ª×›×•×Ÿ ×—×“×©: ${t}`;
        const body = `×©×: ${t}\n×ª×’×™×•×ª: ${selectedTags}\n\n${b}\n\n[× × ×œ×¦×¨×£ ×ª××•× ×” ××• ×§×•×‘×¥ ×× ×™×©]`;
        window.location.href = `mailto:shohamofek@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    // --- GENERATOR LOGIC ---
    function toggleModal(show) {
        document.getElementById('adminModal').style.display = show ? 'flex' : 'none';
        if(show && document.getElementById('gen-ing-rows').children.length === 0) addIngRow(); 
    }

    // UPDATED: Accepts optional item to pre-fill
    function addIngRow(itemData = null) {
        const div = document.createElement('div'); div.className = 'ing-row';
        
        let valAmount = '', valUnit = '', valItem = '';
        if (itemData) {
            valAmount = itemData.amount !== null ? itemData.amount : '';
            valUnit = itemData.unit || '';
            valItem = itemData.item || '';
        }

        div.innerHTML = `
            <input type="text" class="gen-input gen-amount" placeholder="1 ××• 1/2" value="${valAmount}">
            <input type="text" class="gen-input gen-unit" placeholder="×§×´×’" value="${valUnit}">
            <input type="text" class="gen-input gen-item" placeholder="×§××—" value="${valItem}">
            <div class="row-controls">
                <button onclick="moveRow(this, -1)" class="move-btn">â†‘</button>
                <button onclick="moveRow(this, 1)" class="move-btn">â†“</button>
                <button onclick="removeRow(this)" class="remove-row-btn">X</button>
            </div>`;
        document.getElementById('gen-ing-rows').appendChild(div);
    }

    // UPDATED: Accepts optional name to pre-fill
    function addSectionRow(name = '') {
        const div = document.createElement('div'); div.className = 'section-row'; 
        div.innerHTML = `
            <input type="text" class="gen-section-name" placeholder="×©× ×”×§×‘×•×¦×” (×œ××©×œ: ×œ×¨×•×˜×‘)" value="${name}">
            <div class="row-controls">
                <button onclick="moveRow(this, -1)" class="move-btn">â†‘</button>
                <button onclick="moveRow(this, 1)" class="move-btn">â†“</button>
                <button onclick="removeRow(this)" class="remove-row-btn">X</button>
            </div>`;
        document.getElementById('gen-ing-rows').appendChild(div);
    }

    // NEW: Load existing recipe into generator
    function loadRecipeToEdit() {
        if(!currentRecipe) return;
        const r = currentRecipe;
        
        // 1. Fill basic text fields
        document.getElementById('gen-id').value = r.id;
        document.getElementById('gen-title').value = r.title;
        document.getElementById('gen-author').value = r.author;
        document.getElementById('gen-image').value = r.image;
        document.getElementById('gen-url').value = r.sourceUrl || '';
        // Note: For instructions, we just dump the text. Bold/Underline tags remain as text tags <b>...</b>
        document.getElementById('gen-inst').value = r.instructions; 

        // 2. Fill Tags
        document.querySelectorAll('.gen-tag-input').forEach(cb => {
            cb.checked = r.tags.includes(cb.value);
        });

        // 3. Fill Ingredients
        const rowsContainer = document.getElementById('gen-ing-rows');
        rowsContainer.innerHTML = ''; // Clear existing rows
        
        r.ingredients.forEach(entry => {
            if(entry.sectionName) {
                // It's a section
                addSectionRow(entry.sectionName);
                if(entry.items) {
                    entry.items.forEach(subItem => addIngRow(subItem));
                }
            } else if (entry.items) {
                // Rare structure (section without name?), treat as flat items
                 entry.items.forEach(subItem => addIngRow(subItem));
            } else {
                 // Standard flat item
                 addIngRow(entry);
            }
        });
        
        toggleModal(true);
    }

    function moveRow(btn, dir) {
        const row = btn.closest('.ing-row') || btn.closest('.section-row');
        const container = document.getElementById('gen-ing-rows');
        if (dir === -1 && row.previousElementSibling) container.insertBefore(row, row.previousElementSibling);
        else if (dir === 1 && row.nextElementSibling) container.insertBefore(row, row.nextElementSibling.nextElementSibling);
    }
    function removeRow(btn) { const row = btn.closest('.ing-row') || btn.closest('.section-row'); if(row) row.remove(); }
    function wrapText(tag) {
        const textarea = document.getElementById('gen-inst');
        const start = textarea.selectionStart; const end = textarea.selectionEnd; const text = textarea.value;
        if (start === end) return; 
        textarea.value = text.substring(0, start) + `<${tag}>` + text.substring(start, end) + `</${tag}>` + text.substring(end);
    }
    function parseAmount(val) {
        if (!val) return null; val = String(val).trim();
        try { const parts = val.split(' '); let total = 0; for (let part of parts) { if (part.includes('/')) { const [num, den] = part.split('/'); if (den && parseFloat(den) !== 0) total += parseFloat(num) / parseFloat(den); } else { total += parseFloat(part); } } return isNaN(total) ? null : total; } catch (e) { return null; }
    }
    function generateCode() {
        const id = document.getElementById('gen-id').value; const title = document.getElementById('gen-title').value; const author = document.getElementById('gen-author').value; let image = document.getElementById('gen-image').value.trim(); const url = document.getElementById('gen-url').value; const inst = document.getElementById('gen-inst').value;
        if (image && !image.startsWith('http') && !image.startsWith('images/')) image = 'images/' + image;
        const tags = Array.from(document.querySelectorAll('.gen-tag-input:checked')).map(cb => cb.value);
        const rowsContainer = document.getElementById('gen-ing-rows');
        let finalIngredients = []; let currentSection = null;
        Array.from(rowsContainer.children).forEach(row => {
            if (row.classList.contains('section-row')) { const name = row.querySelector('.gen-section-name').value; if (name) { currentSection = { sectionName: name, items: [] }; finalIngredients.push(currentSection); } } 
            else if (row.classList.contains('ing-row')) { const amountStr = row.querySelector('.gen-amount').value; const unit = row.querySelector('.gen-unit').value; const item = row.querySelector('.gen-item').value; const amountVal = parseAmount(amountStr); if (item) { const ingObj = { amount: amountVal, unit: unit, item: item }; if (currentSection) { currentSection.items.push(ingObj); } else { finalIngredients.push(ingObj); } } }
        });
        const obj = { id: id || "new-id", title: title, author: author, tags: tags, image: image, sourceUrl: url, ingredients: finalIngredients, instructions: inst };
        const json = JSON.stringify(obj, null, 4); document.getElementById('gen-output').value = json.replace(/"([^"]+)":/g, '$1:') + ",";
    }

    // --- CLIENT SIDE OPTIMIZER ---
    async function processImages() {
        const files = document.getElementById('opt-files').files;
        if (files.length === 0) { alert('× × ×œ×‘×—×•×¨ ×§×‘×¦×™×'); return; }
        
        const status = document.getElementById('opt-status');
        
        const maxWidth = 400; // Thumbnail width
        let count = 0;

        status.innerHTML = '××¢×‘×“ ×ª××•× ×•×ª...';

        for (let file of files) {
            try {
                // Only process images
                if (!file.type.startsWith('image/')) continue;

                const bitmap = await createImageBitmap(file);
                const scale = maxWidth / bitmap.width;
                const newHeight = bitmap.height * scale;

                const canvas = document.createElement('canvas');
                canvas.width = maxWidth;
                canvas.height = newHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(bitmap, 0, 0, maxWidth, newHeight);

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                
                // Create filename: cake.jpg -> cake_thumb.jpg
                const originalName = file.name;
                const dotIndex = originalName.lastIndexOf('.');
                const namePart = dotIndex !== -1 ? originalName.substring(0, dotIndex) : originalName;
                const newName = `${namePart}_thumb.jpg`;

                // Download directly
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = newName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                count++;
                status.innerHTML = `×”×•×¨×“: ${count}/${files.length}`;
                
                // Small delay to prevent browser choking on multiple downloads
                await new Promise(r => setTimeout(r, 200));

            } catch (e) {
                console.error(e);
                status.innerHTML += `<br>×©×’×™××” ×‘×§×•×‘×¥ ${file.name}`;
            }
        }
        
        status.innerHTML = `×¡×™×•×! ${count} ×ª××•× ×•×ª ×”×•×¨×“×•.`;
    }
</script>

</body>
</html>