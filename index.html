<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××ª×›×•× ×™× ××©×¤×—×ª×™×™×</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="design.css">
</head>
<body>

<div class="container">
    <header class="site-header">
        <!-- Dark/Light Toggle Button -->
        <button class="theme-toggle" onclick="toggleTheme()" title="××¦×‘ ×œ×™×œ×”/×™×•×" aria-label="Toggle Dark Mode">
            <!-- Sun Icon (Visible in Light Mode) -->
            <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <!-- Moon Icon (Visible in Dark Mode) -->
            <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>

        <h1 onclick="navigateHome()">
            ××ª×›×•× ×™× ××©×¤×—×ª×™×™× 
        </h1>
        
        <div class="search-container">
            <input type="text" class="search-box" placeholder="×—×™×¤×•×© ××ª×›×•×Ÿ, ×›×•×ª×‘, ×ª×’×™×ª, ××• ××¨×›×™×‘..." onkeyup="searchRecipes(this.value)">
        </div>
        
        <div class="controls-wrapper">
            <!-- Tags Container -->
            <div id="header-tags" class="tags-scroll-container"></div>

            <!-- Sort Dropdown -->
            <select id="sort-select" onchange="changeSort(this.value)" class="sort-select" aria-label="××™×•×Ÿ ××ª×›×•× ×™×">
                <option value="az" selected>×©× (×-×ª)</option>
                <option value="za">×©× (×ª-×)</option>
                <option value="newest">×”×›×™ ×—×“×©</option>
                <option value="original">×”×›×™ ×™×©×Ÿ</option>
            </select>
        </div>

    </header>

    <main id="app"></main>

    <div class="footer-section">
        <!-- Hiding <h3> via CSS for cleaner look -->
        <!-- Collapsible Draft Form -->
        <details class="draft-details" ontoggle="if(this.open) this.scrollIntoView({behavior: 'smooth', block: 'center'})">
            <summary>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                ×—×¡×¨ ××ª×›×•×Ÿ? ×œ×—×¦×• ×›××Ÿ ×œ×©×œ×™×—×”
            </summary>
            <div class="draft-content">
                <div class="draft-form">
                    <input type="text" id="draft-title" placeholder="×©× ×”×× ×”">
                    <div class="draft-checkboxes" id="draft-tags-container"></div>
                    <textarea id="draft-body" rows="3" placeholder="×¨×©×™××ª ××¦×¨×›×™× ×•×”×•×¨××•×ª..."></textarea>
                    
                    <button class="tag-btn-action" onclick="sendDraft()">
                        ×©×œ×™×—×” ×œ××™×™×œ
                        <svg class="icon-svg" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </details>
        
        <div style="display:flex; justify-content:center; margin-top:20px;">
            <a href="#" onclick="openGenerator(); return false;" class="admin-link">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                ××—×•×œ×œ ××ª×›×•× ×™×
            </a>
            
            <a href="#" onclick="loadRecipeToEdit(); return false;" class="admin-link" id="edit-json-link" style="display: none;">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                ×¢×¨×™×›×”
            </a>
        </div>
    </div>
</div>

<div id="adminModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="toggleModal(false)">âœ–</button>
        
        <h2>××—×•×œ×œ ××ª×›×•× ×™×</h2>
        <input type="text" id="gen-id" class="gen-input" placeholder="ID (×× ×’×œ×™×ª, ×‘×œ×™ ×¨×•×•×—×™×)">
        <input type="text" id="gen-title" class="gen-input" placeholder="×©× ×”××ª×›×•×Ÿ">
        <input type="text" id="gen-author" class="gen-input" placeholder="×™×•×¦×¨">
        <label>×ª×’×™×•×ª:</label>
        <div id="gen-tags-container" class="gen-tags-container" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;"></div>
        <input type="text" id="gen-image" class="gen-input" placeholder="×©× ×§×•×‘×¥ ×ª××•× ×” (×œ××©×œ cake.jpg)">
        <input type="text" id="gen-url" class="gen-input" placeholder="×§×™×©×•×¨ ×œ××§×•×¨ (××•×¤×¦×™×•× ×œ×™)">
        
        <label>××¦×¨×›×™×:</label>
        <div id="gen-ing-rows"></div>
        <div class="add-btn-group">
            <button onclick="addIngRow()" class="gen-input" style="background: var(--tag-bg); border:none; width:auto; flex:2;">+ ××¦×¨×š</button>
            <button onclick="addSectionRow()" class="gen-input" style="background: var(--tag-bg); border:none; width:auto; flex:1;">+ ×›×•×ª×¨×ª</button>
        </div>
        
        <label>×”×•×¨××•×ª ×”×›× ×”:</label>
        <div class="editor-toolbar">
            <button class="toolbar-btn" onclick="wrapText('b')">B</button>
            <button class="toolbar-btn" onclick="wrapText('u')" style="text-decoration:underline;">U</button>
        </div>
        <textarea id="gen-inst" rows="5" class="gen-input"></textarea>
        
        <button class="tag-btn-action" onclick="generateCode()">×¦×•×¨ ×§×•×“</button>
        <textarea id="gen-output" class="gen-input" style="background:#333; color:#0f0; font-family:monospace; margin-top:10px;" rows="5"></textarea>

        <!-- OPTIMIZER TOOL -->
        <div class="optimizer-box">
            <h3>×›×œ×™ ×œ×›×™×•×•×¥ ×ª××•× ×•×ª</h3>
            <input type="file" id="opt-files" multiple accept="image/*" class="gen-input">
            <button class="tag-btn-action" style="background:#2980b9;" onclick="processImages()">
                ×¦×•×¨ ×ª××•× ×” ××•×§×˜× ×ª
            </button>
            <div id="opt-status" style="margin-top:10px; font-size:0.9rem;"></div>
        </div>
    </div>
</div>

<script src="plurals.js"></script>
<script src="recipes.js"></script>
<script src="conversions.js"></script>

<script>
    // --- THEME TOGGLE LOGIC ---
    // This runs immediately to prevent flash of wrong theme
    (function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 
                          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // We need to wait for DOM to toggle icons, so we do it in window.onload or DOMContentLoaded
        window.addEventListener('DOMContentLoaded', () => {
             updateThemeIcons(savedTheme === 'dark');
        });
    })();

    function toggleTheme() {
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        
        root.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcons(!isDark);
    }

    function updateThemeIcons(isDark) {
        const sun = document.querySelector('.sun-icon');
        const moon = document.querySelector('.moon-icon');
        if(sun && moon) {
            sun.style.display = isDark ? 'none' : 'block';
            moon.style.display = isDark ? 'block' : 'none';
        }
    }

    // --- CONFIGURATION ---
    const DEFAULT_IMAGE = "images/no_image.jpg";
    const AVAILABLE_TAGS = ["×—×œ×‘×™", "×¦××—×•× ×™", "×‘×©×¨×™", "×§×™× ×•×—×™×", "×¢×•×’×•×ª", "×¡×œ×˜×™×", "English"];
    let wakeLock = null; 
    let currentRecipe = null;
    let currentLang = 'he';
    let activeTags = new Set();
    let currentSort = 'az';

    // --- INITIALIZATION ---
    const headerTags = document.getElementById('header-tags');
    let tagsHTML = `<button class="tag-btn active-tag" id="tag-all" onclick="filterByTag('')">×”×›×œ</button>`;
    tagsHTML += AVAILABLE_TAGS.map(t => `<button class="tag-btn" id="tag-${t}" onclick="filterByTag('${t}')">${t}</button>`).join('');
    headerTags.innerHTML = tagsHTML;

    const draftTags = document.getElementById('draft-tags-container');
    draftTags.innerHTML = AVAILABLE_TAGS.filter(t=>t!=='English').map(t => `<label class="draft-tag-label"><input type="checkbox" value="${t}" class="draft-tag"> ${t}</label>`).join('');

    const genTags = document.getElementById('gen-tags-container');
    genTags.innerHTML = AVAILABLE_TAGS.map(t => `
        <label style="background:var(--tag-bg); color:var(--text-main); padding:2px 8px; border-radius:10px; display:flex; align-items:center;">
            <input type="checkbox" value="${t}" class="gen-tag-input"> ${t}
        </label>`).join('');

    const app = document.getElementById('app');

    // --- NAVIGATION LOGIC ---
    window.addEventListener('load', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('recipe');
        if (recipeId) showRecipe(recipeId, false);
        else runFilterAndShow('', false);
    });

    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.recipeId) {
            showRecipe(event.state.recipeId, false);
        } else {
            activeTags.clear();
            updateFilterUI();
            showList(recipes, false);
        }
    });
    
    function navigateToRecipe(id) { showRecipe(id, true); }
    
    function navigateHome() { 
        activeTags.clear();
        updateFilterUI();
        document.querySelector('.search-box').value = '';
        history.pushState({}, '', window.location.pathname);
        document.title = "××ª×›×•× ×™× ××©×¤×—×ª×™×™×";
        runFilterAndShow('');
    }

    function changeSort(val) {
        currentSort = val;
        const searchVal = document.querySelector('.search-box').value;
        runFilterAndShow(searchVal);
    }

    // --- SHOW LIST ---
    function showList(data, pushState = true) {
        document.getElementById('edit-json-link').style.display = 'none';

        if (!data || !data.length) { app.innerHTML = '<p style="text-align:center; padding:20px;">×œ× × ××¦××• ×ª×•×¦××•×ª</p>'; return; }
        
        if (pushState) {
            history.pushState({}, '', window.location.pathname);
            document.title = "××ª×›×•× ×™× ××©×¤×—×ª×™×™×";
        }

        const isEnglishMode = activeTags.has('English');

        let html = '<div class="recipe-grid">';
        data.forEach(r => {
            const imgSrc = r.image ? r.image : DEFAULT_IMAGE;
            let thumbSrc = imgSrc;
            if (imgSrc !== DEFAULT_IMAGE && !imgSrc.startsWith('http')) {
                const parts = imgSrc.split('.');
                const ext = parts.pop();
                thumbSrc = parts.join('.') + '_thumb.jpg';
            }

            const displayTitle = (isEnglishMode && r.english) ? r.english.title : r.title;
            const displayAuthor = (isEnglishMode && r.english) ? r.english.author : r.author;

            html += `
                <div class="card" 
                     tabindex="0"
                     onclick="navigateToRecipe('${r.id}')"
                     onkeypress="if(event.key === 'Enter') navigateToRecipe('${r.id}')">
                     
                    <img src="${thumbSrc}" 
                         alt="${displayTitle}" 
                         loading="lazy" 
                         decoding="async"
                         onerror="this.onerror=null; this.src='${imgSrc}'">
                    <div class="card-content">
                        <div>
                            <h2>${displayTitle}</h2>
                            <p class="author">${isEnglishMode ? 'By' : '×××ª'}: ${displayAuthor}</p>
                        </div>
                        <div class="card-tags-wrapper">
                            ${r.tags.map(t => `<span class="badge">${t}</span>`).join('')}
                        </div>
                    </div>
                </div>`;
        });
        html += '</div>';
        app.innerHTML = html;
        window.scrollTo(0,0);
        releaseWakeLock();
    }

    // --- SHOW RECIPE (Restored Layout) ---
    function showRecipe(id, pushState = true) {
        const r = recipes.find(x => x.id === id);
        if (!r) return;
        currentRecipe = r;
        
        currentLang = activeTags.has('English') ? 'en' : 'he';
        
        if (pushState) {
            history.pushState({ recipeId: id }, '', `?recipe=${id}`);
            document.title = `${r.title} | ××ª×›×•× ×™× ××©×¤×—×ª×™×™×`;
        }
        renderRecipeDetail();
        window.scrollTo(0,0);
    }

    function toggleLang(lang) {
        // If specific language passed, use it, otherwise toggle
        if (lang) currentLang = lang;
        else currentLang = (currentLang === 'en') ? 'he' : 'en';
        
        renderRecipeDetail();
    }

    function renderRecipeDetail() {
        document.getElementById('edit-json-link').style.display = 'inline-flex';

        const r = currentRecipe;
        const isEn = currentLang === 'en';
        const data = isEn && r.english ? r.english : r;
        
        const imgSrc = r.image ? r.image : DEFAULT_IMAGE;
        let linkHTML = r.sourceUrl ? `<div style="margin-top:10px;"><a href="${r.sourceUrl}" target="_blank" style="color:var(--primary); font-weight:600; text-decoration:underline;">ğŸ”— ${isEn ? 'Link to original' : '×œ××¢×‘×¨ ×œ××ª×›×•×Ÿ ×”××§×•×¨×™'}</a></div>` : '';

        // Restored Icons (with Text)
        const shareBtn = `
            <button class="tag-btn" onclick="shareRecipe()" title="${isEn ? 'Share recipe link' : '×©×™×ª×•×£ ×§×™×©×•×¨ ×œ××ª×›×•×Ÿ'}">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                ${isEn ? 'Share' : '×©×™×ª×•×£'}
            </button>`;

        const wakeLockTitle = isEn ? "Prevent screen from turning off" : "××•× ×¢ ××”××¡×š ×œ×”×™×›×‘×•×ª ×‘×–××Ÿ ×”×‘×™×©×•×œ";
        const wakeLockBtn = `
            <button class="tag-btn" id="wakeLockBtn" onclick="toggleWakeLock()" title="${wakeLockTitle}">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                ${isEn ? 'Wake Lock' : '××¡×š ×¤×¢×™×œ'}
            </button>`;

        // MODIFIED: Click on the wrapper toggles language regardless of which part is clicked
        const langToggle = r.tags.includes('English') ? `
            <div style="background:var(--tag-bg); padding:3px; border-radius:20px; display:inline-flex; cursor:pointer;" onclick="toggleLang()">
                <button class="tag-btn ${!isEn ? 'active-tag' : ''}" style="border:none; padding:4px 12px; font-size:0.8rem; pointer-events:none;">×¢×‘×¨×™×ª</button>
                <button class="tag-btn ${isEn ? 'active-tag' : ''}" style="border:none; padding:4px 12px; font-size:0.8rem; pointer-events:none;">English</button>
            </div>` : '';

        // Changed inner div to use "nav-actions" class instead of inline style
        app.innerHTML = `
            <div class="recipe-detail ${isEn ? 'english-content' : ''}">
                <div class="recipe-nav">
                    <button class="tag-btn" onclick="navigateHome()">
                        <svg class="icon-svg" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 19 12 12 5"></polyline></svg>
                        ${isEn ? 'Back' : '×—×–×¨×”'}
                    </button>
                    
                    <div class="nav-actions">
                        ${langToggle}
                        ${shareBtn}
                        ${wakeLockBtn}
                    </div>
                </div>

                <div class="recipe-hero">
                    <img src="${imgSrc}" class="recipe-hero-image" alt="${data.title}">
                    <div class="recipe-header-content">
                        <h1>${data.title}</h1>
                        <p class="author">${isEn ? 'By' : '×××ª'}: ${data.author}</p>
                        ${linkHTML}
                    </div>
                </div>

                <div class="recipe-body-grid">
                    <aside class="ingredients-column">
                        ${data.ingredients && data.ingredients.length > 0 ? `
                        <div class="scaler">
                            <span style="align-self:center; font-size:0.9rem; color:var(--text-muted);">${isEn ? 'Scale' : '×›××•×™×•×ª'}:</span>
                            <button class="scale-btn" id="btn-0.5" onclick="renderIngredients(0.5)">0.5x</button>
                            <button class="scale-btn active" id="btn-1" onclick="renderIngredients(1)">1x</button>
                            <button class="scale-btn" id="btn-1.5" onclick="renderIngredients(1.5)">1.5x</button>
                            <button class="scale-btn" id="btn-2" onclick="renderIngredients(2)">2x</button>
                        </div>
                        <div id="ing-list" class="ingredients-list"></div>
                        ` : '<p>No ingredients listed.</p>'}
                    </aside>

                    <section class="instructions">
                        <h3>${isEn ? 'Instructions' : '×”×•×¨××•×ª ×”×›× ×”'}</h3>
                        <div style="font-size:1.1rem; line-height:1.8;">
                            ${formatInstructions(data.instructions)}
                        </div>
                    </section>
                </div>
            </div>
        `;
        
        if(wakeLock && document.getElementById('wakeLockBtn')) {
             document.getElementById('wakeLockBtn').classList.add('active-tag');
        }

        if(data.ingredients && data.ingredients.length > 0) renderIngredients(1);
    }

    // --- WAKE LOCK ---
    async function toggleWakeLock() {
        const btn = document.getElementById('wakeLockBtn');
        if (!wakeLock) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => {
                    wakeLock = null;
                    if(btn) btn.classList.remove('active-tag');
                });
                if(btn) btn.classList.add('active-tag');
            } catch (err) {
                console.error(err);
                alert("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š");
            }
        } else {
            await wakeLock.release();
        }
    }
    function releaseWakeLock() { if (wakeLock) { wakeLock.release(); wakeLock = null; } }
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') await toggleWakeLock();
    });

    // --- SHARE ---
    async function shareRecipe() {
        if (!currentRecipe) return;
        if (navigator.share) {
            try { await navigator.share({ title: currentRecipe.title, text: `${currentRecipe.title}`, url: window.location.href }); } catch (err) {}
        } else {
            try { await navigator.clipboard.writeText(window.location.href); alert("×”×§×™×©×•×¨ ×”×•×¢×ª×§"); } catch (err) {}
        }
    }

    // --- FORMATTERS ---
    function formatInstructions(text) {
        if (!text) return '';
        const lines = text.split('\n').filter(line => line.trim() !== '');
        let html = '';
        let listType = null;
        lines.forEach(line => {
            line = line.trim();
            const orderedMatch = line.match(/^(\d+)[\.\)\-]\s+(.*)/);
            const unorderedMatch = line.match(/^[\-\*]\s+(.*)/);
            if (orderedMatch) {
                if (listType !== 'ol') { if (listType) html += `</${listType}>`; html += '<ol>'; listType = 'ol'; }
                html += `<li>${orderedMatch[2]}</li>`; 
            } else if (unorderedMatch) {
                if (listType !== 'ul') { if (listType) html += `</${listType}>`; html += '<ul>'; listType = 'ul'; }
                html += `<li>${unorderedMatch[1]}</li>`;
            } else {
                if (listType) { html += `</${listType}>`; listType = null; }
                html += `<p>${line}</p>`;
            }
        });
        if (listType) html += `</${listType}>`;
        return html;
    }

    function formatAmount(amount) {
        if (typeof amount !== 'number') return amount;
        if (Number.isInteger(amount)) return amount;
        const epsilon = 0.05; 
        const decimal = amount % 1;
        const integer = Math.floor(amount);
        let fraction = '';
        if (Math.abs(decimal - 0.25) < epsilon) fraction = '1/4';
        else if (Math.abs(decimal - 0.33) < epsilon) fraction = '1/3';
        else if (Math.abs(decimal - 0.5) < epsilon) fraction = '1/2';
        else if (Math.abs(decimal - 0.66) < epsilon) fraction = '2/3';
        else if (Math.abs(decimal - 0.75) < epsilon) fraction = '3/4';
        if (fraction) return integer > 0 ? `${integer} ${fraction}` : fraction;
        return amount.toFixed(2).replace(/\.?0+$/, '');
    }

    function renderIngredients(mult) {
        document.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btn-${mult}`);
        if(btn) btn.classList.add('active');

        const isEn = currentLang === 'en';
        const data = isEn && currentRecipe.english ? currentRecipe.english : currentRecipe;
        
        let html = '<ul>';
        const processItems = (items) => {
            return items.map(item => {
                let rawVal = item.amount ? (item.amount * mult) : '';
                let displayVal = rawVal;
                let conversionText = '';
                
                // Determine Singular or Plural form
                let displayUnit = item.unit || '';
                let displayItem = item.item || '';

                if (typeof rawVal === 'number') {
                    const conv = getConversion(rawVal, item.unit, item.item, isEn ? 'en' : 'he');
                    if (conv) conversionText = `<span style="font-weight:normal; font-size:0.85em; color:var(--text-muted);">(${conv})</span>`;
                    displayVal = formatAmount(rawVal);
                    
                    // Pluralization Logic
                    if (typeof getPlural === 'function') {
                        displayUnit = getPlural(item.unit, rawVal);
                        displayItem = getPlural(item.item, rawVal);
                    }
                }

                const shouldShowBold = (displayVal !== '') || (displayUnit && displayUnit.trim().length > 0);
                const amountHTML = shouldShowBold 
                    ? `<strong><span style="direction:ltr; unicode-bidi:embed;">${displayVal}</span> ${displayUnit}</strong> `
                    : '';
                return `<li onclick="this.classList.toggle('checked')">
                    <span class="ing-content">
                        ${amountHTML}<span>${displayItem} ${conversionText}</span>
                    </span>
                </li>`;
            }).join('');
        };
        data.ingredients.forEach(entry => {
            if (entry.sectionName) { html += `</ul><h4 class="ing-section-title">${entry.sectionName}</h4><ul>`; html += processItems(entry.items); } 
            else if (entry.amount !== undefined) { html += processItems([entry]); }
        });
        html += '</ul>';
        const container = document.getElementById('ing-list');
        if(container) container.innerHTML = html;
    }

    // --- SEARCH & FILTER ---
    function filterByTag(tag) {
        if (tag === '') activeTags.clear();
        else {
            if (activeTags.has(tag)) activeTags.delete(tag);
            else activeTags.add(tag);
        }
        updateFilterUI();
        runFilterAndShow();
    }

    function updateFilterUI() {
        document.querySelectorAll('.tag-btn').forEach(btn => {
            const btnId = btn.id;
            if (btnId === 'tag-all') {
                if (activeTags.size === 0) btn.classList.add('active-tag');
                else btn.classList.remove('active-tag');
            } else {
                const tagName = btnId.replace('tag-', '');
                if (activeTags.has(tagName)) btn.classList.add('active-tag');
                else btn.classList.remove('active-tag');
            }
        });
        const searchBox = document.querySelector('.search-box');
        if (activeTags.has('English')) {
            searchBox.placeholder = "Search recipes, ingredients, authors...";
            searchBox.style.direction = "ltr";
        } else {
            searchBox.placeholder = "×—×™×¤×•×© ××ª×›×•×Ÿ, ×›×•×ª×‘, ×ª×’×™×ª, ××• ××¨×›×™×‘...";
            searchBox.style.direction = "rtl";
        }
    }

    function searchRecipes(q) { runFilterAndShow(q); }

    function runFilterAndShow(searchTerm = '') {
        const rawTerm = searchTerm.toLowerCase().trim();
        const isEnglishMode = activeTags.has('English');
        
        // --- SEARCH TERMS ---
        // Start with exactly what the user typed
        let searchVariations = [rawTerm];
        
        // If the word exists in our dictionary, add its partner (Singular/Plural)
        // We check if plurals.js is loaded and the word exists
        if (rawTerm && typeof WORD_FORMS !== 'undefined' && WORD_FORMS[rawTerm]) {
            const entry = WORD_FORMS[rawTerm];
            // Add both Singular and Plural forms to the search list if not already there
            if (!searchVariations.includes(entry.s)) searchVariations.push(entry.s);
            if (!searchVariations.includes(entry.p)) searchVariations.push(entry.p);
        }

        // Helper: Returns true if ANY of the variations exist in the text
        const hasMatch = (text) => {
            if (!text) return false;
            const lowerText = text.toLowerCase();
            return searchVariations.some(v => lowerText.includes(v));
        };
        // -------------------------------

        let filtered = recipes.filter(r => {
            // 1. Tag Filter
            if (activeTags.size > 0) {
                for (let tag of activeTags) { if (!r.tags.includes(tag)) return false; }
            }
            
            // 2. Search Filter (if empty, show all)
            if (rawTerm === '') return true;

            if (isEnglishMode) {
                if (!r.english) return false;
                const title = r.english.title || '';
                const author = r.english.author || '';
                
                // Check Ingredients using the new helper
                const ing = r.english.ingredients.some(entry => {
                    if (entry.items) return entry.items.some(sub => hasMatch(sub.item));
                    return entry.item && hasMatch(entry.item);
                });
                
                return hasMatch(title) || hasMatch(author) || ing;

            } else {
                // Hebrew Logic
                const inTitle = hasMatch(r.title);
                // Check tags too (so searching "×—×œ×‘×™" works)
                const inTags = r.tags.some(t => hasMatch(t));
                const inAuthor = r.author && hasMatch(r.author);
                
                const inIngredients = r.ingredients.some(entry => {
                    if (entry.items) return entry.items.some(sub => hasMatch(sub.item));
                    return entry.item && hasMatch(entry.item);
                });

                return inTitle || inTags || inIngredients || inAuthor;
            }
        });

        // --- SORTING ---
        if (currentSort === 'az') {
            filtered.sort((a, b) => {
                const titleA = (isEnglishMode && a.english) ? a.english.title : a.title;
                const titleB = (isEnglishMode && b.english) ? b.english.title : b.title;
                return titleA.trim().localeCompare(titleB.trim(), isEnglishMode ? 'en' : 'he');
            });
        } else if (currentSort === 'za') {
            filtered.sort((a, b) => {
                const titleA = (isEnglishMode && a.english) ? a.english.title : a.title;
                const titleB = (isEnglishMode && b.english) ? b.english.title : b.title;
                return titleB.trim().localeCompare(titleA.trim(), isEnglishMode ? 'en' : 'he');
            });
        } else if (currentSort === 'newest') {
             filtered.reverse();
        }

        showList(filtered, false);
    }

    function sendDraft() {
        const t = document.getElementById('draft-title').value;
        const b = document.getElementById('draft-body').value;
        const selectedTags = Array.from(document.querySelectorAll('.draft-tag:checked')).map(cb => cb.value).join(', ');
        const subject = `××ª×›×•×Ÿ ×—×“×©: ${t}`;
        const body = `×©×: ${t}\n×ª×’×™×•×ª: ${selectedTags}\n\n${b}\n\n[× × ×œ×¦×¨×£ ×ª××•× ×” ××• ×§×•×‘×¥ ×× ×™×©]`;
        window.location.href = `mailto:shohamofek@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    // --- GENERATOR LOGIC (SAME AS BEFORE) ---
    function toggleModal(show) {
        document.getElementById('adminModal').style.display = show ? 'flex' : 'none';
        if(show && document.getElementById('gen-ing-rows').children.length === 0) addIngRow(); 
    }
    
    // NEW: Open Generator and clear fields
    function openGenerator() {
        // Clear all fields
        document.getElementById('gen-id').value = '';
        document.getElementById('gen-title').value = '';
        document.getElementById('gen-author').value = '';
        document.getElementById('gen-image').value = '';
        document.getElementById('gen-url').value = '';
        document.getElementById('gen-inst').value = '';
        document.getElementById('gen-output').value = '';
        
        // Reset tags
        document.querySelectorAll('.gen-tag-input').forEach(cb => { cb.checked = false; });
        
        // Reset ingredients to one empty row
        const rowsContainer = document.getElementById('gen-ing-rows');
        rowsContainer.innerHTML = '';
        addIngRow();
        
        toggleModal(true);
    }

    function addIngRow(itemData = null) {
        const div = document.createElement('div'); div.className = 'ing-row';
        let valAmount = '', valUnit = '', valItem = '';
        if (itemData) { valAmount = itemData.amount !== null ? itemData.amount : ''; valUnit = itemData.unit || ''; valItem = itemData.item || ''; }
        div.innerHTML = `<input type="text" class="gen-input gen-amount" placeholder="×›××•×ª" value="${valAmount}"><input type="text" class="gen-input gen-unit" placeholder="×™×—'" value="${valUnit}"><input type="text" class="gen-input gen-item" placeholder="××•×¦×¨" value="${valItem}"><button onclick="this.parentElement.remove()" style="background:#ff7675;color:white;border:none;border-radius:4px;">X</button>`;
        document.getElementById('gen-ing-rows').appendChild(div);
    }
    function addSectionRow(name = '') {
        const div = document.createElement('div'); div.className = 'ing-row'; div.style.display="flex"; 
        div.innerHTML = `<input type="text" class="gen-section-name" style="flex:1;background:#e0ffe0;border:1px solid #ccc;padding:8px;" placeholder="×›×•×ª×¨×ª ××©× ×”" value="${name}"><button onclick="this.parentElement.remove()" style="background:#ff7675;color:white;border:none;border-radius:4px;padding:0 10px;">X</button>`;
        document.getElementById('gen-ing-rows').appendChild(div);
    }
    function loadRecipeToEdit() {
        if(!currentRecipe) return;
        const r = currentRecipe;
        document.getElementById('gen-id').value = r.id;
        document.getElementById('gen-title').value = r.title;
        document.getElementById('gen-author').value = r.author;
        document.getElementById('gen-image').value = r.image;
        document.getElementById('gen-url').value = r.sourceUrl || '';
        document.getElementById('gen-inst').value = r.instructions; 
        document.querySelectorAll('.gen-tag-input').forEach(cb => { cb.checked = r.tags.includes(cb.value); });
        const rowsContainer = document.getElementById('gen-ing-rows');
        rowsContainer.innerHTML = ''; 
        r.ingredients.forEach(entry => {
            if(entry.sectionName) { addSectionRow(entry.sectionName); if(entry.items) entry.items.forEach(subItem => addIngRow(subItem)); } 
            else if (entry.items) { entry.items.forEach(subItem => addIngRow(subItem)); } else { addIngRow(entry); }
        });
        toggleModal(true);
    }
    function wrapText(tag) {
        const textarea = document.getElementById('gen-inst');
        const start = textarea.selectionStart; const end = textarea.selectionEnd; const text = textarea.value;
        if (start === end) return; 
        textarea.value = text.substring(0, start) + `<${tag}>` + text.substring(start, end) + `</${tag}>` + text.substring(end);
    }
    function parseAmount(val) {
        if (!val) return null; val = String(val).trim();
        try { const parts = val.split(' '); let total = 0; for (let part of parts) { if (part.includes('/')) { const [num, den] = part.split('/'); if (den && parseFloat(den) !== 0) total += parseFloat(num) / parseFloat(den); } else { total += parseFloat(part); } } return isNaN(total) ? null : total; } catch (e) { return null; }
    }
    function generateCode() {
        const id = document.getElementById('gen-id').value; const title = document.getElementById('gen-title').value; const author = document.getElementById('gen-author').value; let image = document.getElementById('gen-image').value.trim(); const url = document.getElementById('gen-url').value; const inst = document.getElementById('gen-inst').value;
        if (image && !image.startsWith('http') && !image.startsWith('images/')) image = 'images/' + image;
        const tags = Array.from(document.querySelectorAll('.gen-tag-input:checked')).map(cb => cb.value);
        const rowsContainer = document.getElementById('gen-ing-rows');
        let finalIngredients = []; let currentSection = null;
        Array.from(rowsContainer.children).forEach(row => {
            if (row.querySelector('.gen-section-name')) { const name = row.querySelector('.gen-section-name').value; if (name) { currentSection = { sectionName: name, items: [] }; finalIngredients.push(currentSection); } } 
            else if (row.classList.contains('ing-row')) { const amountStr = row.querySelector('.gen-amount').value; const unit = row.querySelector('.gen-unit').value; const item = row.querySelector('.gen-item').value; const amountVal = parseAmount(amountStr); if (item) { const ingObj = { amount: amountVal, unit: unit, item: item }; if (currentSection) { currentSection.items.push(ingObj); } else { finalIngredients.push(ingObj); } } }
        });
        const obj = { id: id || "new-id", title: title, author: author, tags: tags, image: image, sourceUrl: url, ingredients: finalIngredients, instructions: inst };
        const json = JSON.stringify(obj, null, 4); document.getElementById('gen-output').value = json.replace(/"([^"]+)":/g, '$1:') + ",";
    }
    async function processImages() {
        const files = document.getElementById('opt-files').files;
        if (files.length === 0) { alert('× × ×œ×‘×—×•×¨ ×§×‘×¦×™×'); return; }
        const status = document.getElementById('opt-status');
        const maxWidth = 400; let count = 0; status.innerHTML = '××¢×‘×“ ×ª××•× ×•×ª...';
        for (let file of files) {
            try {
                if (!file.type.startsWith('image/')) continue;
                const bitmap = await createImageBitmap(file);
                const scale = maxWidth / bitmap.width;
                const newHeight = bitmap.height * scale;
                const canvas = document.createElement('canvas');
                canvas.width = maxWidth; canvas.height = newHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(bitmap, 0, 0, maxWidth, newHeight);
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                const originalName = file.name; const dotIndex = originalName.lastIndexOf('.'); const namePart = dotIndex !== -1 ? originalName.substring(0, dotIndex) : originalName; const newName = `${namePart}_thumb.jpg`;
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = newName; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                count++; status.innerHTML = `×”×•×¨×“: ${count}/${files.length}`; await new Promise(r => setTimeout(r, 200));
            } catch (e) { console.error(e); status.innerHTML += `<br>×©×’×™××” ×‘×§×•×‘×¥ ${file.name}`; }
        }
        status.innerHTML = `×¡×™×•×! ${count} ×ª××•× ×•×ª ×”×•×¨×“×•.`;
    }
</script>

</body>
</html>