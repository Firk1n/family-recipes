<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××ª×›×•× ×™× ××©×¤×—×ª×™×™×</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="design.css">
    <link href="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.snow.css" rel="stylesheet">
</head>
<body>

<div class="container">
    <header class="site-header">
        <!-- Dark/Light Toggle Button -->
        <button class="theme-toggle" onclick="toggleTheme()" title="××¦×‘ ×œ×™×œ×”/×™×•×" aria-label="Toggle Dark Mode">
            <!-- Sun Icon (Visible in Light Mode) -->
            <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <!-- Moon Icon (Visible in Dark Mode) -->
            <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>

        <h1 onclick="navigateHome()">
            ××ª×›×•× ×™× ××©×¤×—×ª×™×™× 
        </h1>
        
        <div class="search-container">
            <input type="text" class="search-box" placeholder="×—×™×¤×•×© ××ª×›×•×Ÿ, ×›×•×ª×‘, ×ª×’×™×ª, ××• ××¨×›×™×‘..." onkeyup="searchRecipes(this.value)">
        </div>
            <div id="recipe-count" style="text-align: center; margin: 2px 0 10px 0; color: var(--text-muted); font-size: 0.9rem;"></div>

        <div class="controls-wrapper">
            <!-- Tags Container -->
            <div id="header-tags" class="tags-scroll-container"></div>

            <!-- Sort Dropdown -->
            <select id="sort-select" onchange="changeSort(this.value)" class="sort-select" aria-label="××™×•×Ÿ ××ª×›×•× ×™×">
                <option value="az" selected>×©× (×-×ª)</option>
                <option value="za">×©× (×ª-×)</option>
                <option value="newest">×”×›×™ ×—×“×©</option>
                <option value="original">×”×›×™ ×™×©×Ÿ</option>
            </select>
        </div>

    </header>

    <main id="app"></main>

    <div class="footer-section">
        <!-- Hiding <h3> via CSS for cleaner look -->
        <!-- Collapsible Draft Form -->
        <details class="draft-details" ontoggle="if(this.open) this.scrollIntoView({behavior: 'smooth', block: 'center'})">
            <summary>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                ×—×¡×¨ ××ª×›×•×Ÿ? ×œ×—×¦×• ×›××Ÿ ×œ×©×œ×™×—×”
            </summary>
            <div class="draft-content">
                <div class="draft-form">
                    <input type="text" id="draft-title" placeholder="×©× ×”×× ×”">
                    <div class="draft-checkboxes" id="draft-tags-container"></div>
                    <textarea id="draft-body" rows="3" placeholder="×¨×©×™××ª ××¦×¨×›×™× ×•×”×•×¨××•×ª..."></textarea>
                    
                    <button class="tag-btn-action" onclick="sendDraft()">
                        ×©×œ×™×—×” ×œ××™×™×œ
                        <svg class="icon-svg" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </details>
        
        <div style="display:flex; justify-content:center; margin-top:20px;">
            <a href="#" onclick="startNewRecipe(); return false;" class="admin-link">
                <svg class="icon-svg" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                ××ª×›×•×Ÿ ×—×“×©
            </a>
            
            <a href="#" onclick="enterEditMode(); return false;" class="admin-link" id="edit-json-link" style="display: none;">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                ×¢×¨×™×›×”
            </a>
        </div>
    </div>
</div>

<div id="adminModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="toggleModal(false)">âœ–</button>
        
        <h2 style="margin-top:0;">××—×•×œ×œ ××ª×›×•× ×™×</h2>
        <input type="text" id="gen-id" class="gen-input" placeholder="ID (×× ×’×œ×™×ª, ×‘×œ×™ ×¨×•×•×—×™×)">
        <input type="text" id="gen-title" class="gen-input" placeholder="×©× ×”××ª×›×•×Ÿ">
        <input type="text" id="gen-author" class="gen-input" placeholder="×™×•×¦×¨">
        <label>×ª×’×™×•×ª:</label>
        <div id="gen-tags-container" class="gen-tags-container" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;"></div>
        <input type="text" id="gen-image" class="gen-input" placeholder="×©× ×§×•×‘×¥ ×ª××•× ×” (×œ××©×œ cake.jpg)">
        <input type="text" id="gen-url" class="gen-input" placeholder="×§×™×©×•×¨ ×œ××§×•×¨ (××•×¤×¦×™×•× ×œ×™)">
        
        <label>××¦×¨×›×™×:</label>
        <div id="gen-ing-rows"></div>
        <div class="add-btn-group">
            <button onclick="addIngRow()" style="flex:2;">+ ××¨×›×™×‘</button>
            <button onclick="addSectionRow()" style="flex:1;">+ ×›×•×ª×¨×ª</button>
        </div>
        
        <label>×”×•×¨××•×ª ×”×›× ×”:</label>
        <div class="editor-toolbar" style="margin-bottom:5px;">
            <button class="gen-icon-btn" onclick="wrapText('b')" style="border:1px solid var(--border-color); display:inline-block; width:30px;">B</button>
            <button class="gen-icon-btn" onclick="wrapText('u')" style="text-decoration:underline; border:1px solid var(--border-color); display:inline-block; width:30px;">U</button>
        </div>
        <textarea id="gen-inst" rows="5" class="gen-input"></textarea>
        
        <button class="tag-btn-action" onclick="generateCode()">×¦×•×¨ ×§×•×“</button>
        <textarea id="gen-output" class="gen-input" style="background:var(--input-bg); color:var(--text-main); font-family:monospace; margin-top:10px;" rows="5" dir="ltr"></textarea>

        <!-- OPTIMIZER TOOL -->
        <div class="optimizer-box" style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:20px;">
            <h3>×›×œ×™ ×œ×›×™×•×•×¥ ×ª××•× ×•×ª</h3>
            <input type="file" id="opt-files" multiple accept="image/*" class="gen-input">
            <button class="tag-btn-action" style="background:#2980b9;" onclick="processImages()">
                ×¦×•×¨ ×ª××•× ×” ××•×§×˜× ×ª
            </button>
            <div id="opt-status" style="margin-top:10px; font-size:0.9rem;"></div>
        </div>
    </div>
</div>

<script src="plurals.js"></script>
<script src="recipes.js"></script>
<script src="conversions.js"></script>

<script>
    // --- THEME TOGGLE LOGIC ---
    // This runs immediately to prevent flash of wrong theme
    (function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 
                          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // We need to wait for DOM to toggle icons, so we do it in window.onload or DOMContentLoaded
        window.addEventListener('DOMContentLoaded', () => {
             updateThemeIcons(savedTheme === 'dark');
        });
    })();

    function toggleTheme() {
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        
        root.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcons(!isDark);
    }

    function updateThemeIcons(isDark) {
        const sun = document.querySelector('.sun-icon');
        const moon = document.querySelector('.moon-icon');
        if(sun && moon) {
            sun.style.display = isDark ? 'none' : 'block';
            moon.style.display = isDark ? 'block' : 'none';
        }
    }

    // --- BOOKMARKS SYSTEM ---
    function getBookmarks() {
        const saved = localStorage.getItem('bookmarked-recipes');
        return saved ? JSON.parse(saved) : [];
    }
    
    function saveBookmarks(bookmarks) {
        localStorage.setItem('bookmarked-recipes', JSON.stringify(bookmarks));
    }
    
    function isBookmarked(recipeId) {
        const bookmarks = getBookmarks();
        return bookmarks.includes(recipeId);
    }
    
    function toggleBookmark(recipeId, event) {
        if (event) event.stopPropagation();
        let bookmarks = getBookmarks();
        const index = bookmarks.indexOf(recipeId);
        if (index > -1) bookmarks.splice(index, 1);
        else bookmarks.push(recipeId);
        saveBookmarks(bookmarks);
        if (currentRecipe && currentRecipe.id === recipeId) renderRecipeDetail();
        else applyFiltersAndSort();
    }
    
    let showingOnlyBookmarks = false;
    function filterBookmarks() {
        showingOnlyBookmarks = !showingOnlyBookmarks;
        
        
        const btn = document.getElementById('bookmarks-filter-btn');
        if (btn) {
            if (showingOnlyBookmarks) btn.classList.add('active-tag');
            else btn.classList.remove('active-tag');
        }
        applyFiltersAndSort();
    }


    // --- RECIPE NOTES ---
    function getRecipeNotes(recipeId) {
        const notes = localStorage.getItem(`recipe-notes-${recipeId}`);
        return notes || '';
    }
    
    function saveRecipeNotes(recipeId, notes) {
        if (notes.trim()) {
            localStorage.setItem(`recipe-notes-${recipeId}`, notes);
        } else {
            localStorage.removeItem(`recipe-notes-${recipeId}`);
        }
    }
    
    function toggleNotesEditor() {
        const editor = document.getElementById('notes-editor');
        const display = document.getElementById('notes-display');
        const editBtn = document.getElementById('notes-edit-btn');
        const deleteBtn = document.getElementById('notes-delete-btn');
        const notesFull = document.getElementById('notes-section-full');
        const notesEmpty = document.getElementById('notes-section-empty');
        const isEditing = editor.style.display !== 'none';
        
        if (isEditing) {
            // Save and close
            const notes = document.getElementById('notes-textarea').value;
            saveRecipeNotes(currentRecipe.id, notes);
            
            editor.style.display = 'none';
            editBtn.style.display = 'inline-flex';
            if (notes.trim()) {
                display.innerHTML = `<p style="white-space: pre-wrap; margin: 0;">${notes}</p>`;
                display.style.display = 'block';
                deleteBtn.style.display = 'inline-flex';
                notesFull.style.display = 'block';
                notesEmpty.style.display = 'none';
            } else {
                display.style.display = 'none';
                deleteBtn.style.display = 'none';
                notesFull.style.display = 'none';
                notesEmpty.style.display = 'block';
            }
        } else {
            // Open editor â€” hide edit & delete buttons
            editBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            const currentNotes = getRecipeNotes(currentRecipe.id);
            document.getElementById('notes-textarea').value = currentNotes;
            editor.style.display = 'block';
            display.style.display = 'none';
            document.getElementById('notes-textarea').focus();
        }
    }

    function cancelNotesEditor() {
        const editor = document.getElementById('notes-editor');
        const display = document.getElementById('notes-display');
        const editBtn = document.getElementById('notes-edit-btn');
        const deleteBtn = document.getElementById('notes-delete-btn');
        const notesFull = document.getElementById('notes-section-full');
        const notesEmpty = document.getElementById('notes-section-empty');
        const savedNotes = getRecipeNotes(currentRecipe.id);
        
        editor.style.display = 'none';
        editBtn.style.display = 'inline-flex';
        if (savedNotes) {
            display.innerHTML = `<p style="white-space: pre-wrap; margin: 0;">${savedNotes}</p>`;
            display.style.display = 'block';
            deleteBtn.style.display = 'inline-flex';
        } else {
            notesFull.style.display = 'none';
            notesEmpty.style.display = 'block';
        }
    }

    function openNotesFromEmpty() {
        const notesFull = document.getElementById('notes-section-full');
        const notesEmpty = document.getElementById('notes-section-empty');
        notesFull.style.display = 'block';
        notesEmpty.style.display = 'none';
        document.getElementById('notes-edit-btn').style.display = 'none';
        document.getElementById('notes-textarea').value = '';
        document.getElementById('notes-editor').style.display = 'block';
        document.getElementById('notes-display').style.display = 'none';
        document.getElementById('notes-delete-btn').style.display = 'none';
        document.getElementById('notes-textarea').focus();
    }

    function deleteRecipeNotes() {
        if (!confirm('×œ××—×•×§ ××ª ×”×”×¢×¨×•×ª?')) return;
        saveRecipeNotes(currentRecipe.id, '');
        document.getElementById('notes-display').style.display = 'none';
        document.getElementById('notes-editor').style.display = 'none';
        document.getElementById('notes-delete-btn').style.display = 'none';
        document.getElementById('notes-section-full').style.display = 'none';
        document.getElementById('notes-section-empty').style.display = 'block';
    }

    // --- CONFIGURATION ---
    const DEFAULT_IMAGE = "images/no_image.jpg";
    const AVAILABLE_TAGS = ["×—×œ×‘×™", "×¦××—×•× ×™", "×‘×©×¨×™", "×“×’×™×", "×§×™× ×•×—×™×", "×¢×•×’×•×ª", "×¡×œ×˜×™×", "English"];
    let wakeLock = null; 
    let currentRecipe = null;
    let currentLang = 'he';
    let activeTags = new Set();
    let currentSort = 'az';

    // --- INITIALIZATION ---
    const headerTags = document.getElementById('header-tags');
    let tagsHTML = `<button class="tag-btn active-tag" id="tag-all" onclick="filterByTag('')">×”×›×œ</button>`;
    tagsHTML += `<button class="tag-btn" id="bookmarks-filter-btn" onclick="filterBookmarks()" title="××•×¢×“×¤×™×">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
    </button>`;
    tagsHTML += AVAILABLE_TAGS.map(t => `<button class="tag-btn" id="tag-${t}" onclick="filterByTag('${t}')">${t}</button>`).join('');
    headerTags.innerHTML = tagsHTML;

    const draftTags = document.getElementById('draft-tags-container');
    draftTags.innerHTML = AVAILABLE_TAGS.filter(t=>t!=='English').map(t => `<label class="draft-tag-label"><input type="checkbox" value="${t}" class="draft-tag"> ${t}</label>`).join('');

    const genTags = document.getElementById('gen-tags-container');
    genTags.innerHTML = AVAILABLE_TAGS.map(t => `
        <label style="background:var(--tag-bg); color:var(--text-main); padding:2px 8px; border-radius:10px; display:flex; align-items:center;">
            <input type="checkbox" value="${t}" class="gen-tag-input"> ${t}
        </label>`).join('');

    const app = document.getElementById('app');

    // --- NAVIGATION LOGIC ---
    window.addEventListener('load', () => {
        // Init sorting from localStorage
        const savedSort = localStorage.getItem('sortOrder') || 'az';
        currentSort = savedSort;
        const sortSelect = document.getElementById('sort-select');
        if (sortSelect) sortSelect.value = savedSort;

        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('recipe');
        if (recipeId) showRecipe(recipeId, false);
        else runFilterAndShow('', false);
    });

    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.recipeId) {
            showRecipe(event.state.recipeId, false);
        } else {
            activeTags.clear();
            updateFilterUI();
            showList(recipes, false);
        }
    });
    
    function navigateToRecipe(id) { showRecipe(id, true); }
    
    function navigateHome() { 
        activeTags.clear();
        updateFilterUI();
        document.querySelector('.search-box').value = '';
        history.pushState({}, '', window.location.pathname);
        document.title = "××ª×›×•× ×™× ××©×¤×—×ª×™×™×";
        runFilterAndShow('');
        window.scrollTo(0,0);
    }

    function changeSort(val) {
        currentSort = val;
        localStorage.setItem('sortOrder', val);
        const searchVal = document.querySelector('.search-box').value;
        runFilterAndShow(searchVal);
    }

    // --- SHOW LIST ---
    function showList(data, pushState = true) {
        const countEl = document.getElementById('recipe-count');
        if (countEl) countEl.textContent = `${data ? data.length : 0} ××ª×›×•× ×™×`;

        document.getElementById('edit-json-link').style.display = 'none';

        if (!data || !data.length) { 
            app.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 20px; opacity: 0.5;">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <h2 style="color: var(--header-text); margin-bottom: 10px;">×œ× × ××¦××• ××ª×›×•× ×™×</h2>
                    <p>× ×¡×• ×œ×—×¤×© ××©×”×• ××—×¨ ××• ×œ×‘×˜×œ ××ª ×”×¡×™× ×•×Ÿ</p>
                </div>
            `;
            return; 
        }
        
        if (pushState) {
            history.pushState({}, '', window.location.pathname);
            document.title = "××ª×›×•× ×™× ××©×¤×—×ª×™×™×";
        }

        const isEnglishMode = activeTags.has('English');

        let html = '<div class="recipe-grid">';
        data.forEach(r => {
            const imgSrc = r.image ? r.image : DEFAULT_IMAGE;
            let thumbSrc = imgSrc;
            if (imgSrc !== DEFAULT_IMAGE && !imgSrc.startsWith('http')) {
                const parts = imgSrc.split('.');
                const ext = parts.pop();
                thumbSrc = parts.join('.') + '_thumb.jpg';
            }

            const displayTitle = (isEnglishMode && r.english) ? r.english.title : r.title;
            const displayAuthor = (isEnglishMode && r.english) ? r.english.author : r.author;

            html += `
                <div class="card" 
                     tabindex="0"
                     onclick="navigateToRecipe('${r.id}')"
                     onkeypress="if(event.key === 'Enter') navigateToRecipe('${r.id}')">
                    <img src="${thumbSrc}" 
                         alt="${displayTitle}" 
                         loading="lazy" 
                         decoding="async"
                         onerror="this.onerror=null; this.src='${imgSrc}'">
                    <button class="bookmark-btn" onclick="toggleBookmark('${r.id}', event); event.stopPropagation();" title="${isBookmarked(r.id) ? '×”×¡×¨×” ××”××•×¢×“×¤×™×' : '×”×•×¡×¤×” ×œ××•×¢×“×¤×™×'}">
                        <svg viewBox="0 0 24 24" fill="${isBookmarked(r.id) ? '#dc2626' : 'none'}" stroke="${isBookmarked(r.id) ? '#dc2626' : 'currentColor'}" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                    <div class="card-content">
                        <div>
                            <h2>${displayTitle}</h2>
                            <p class="author">${isEnglishMode ? 'By' : '×××ª'}: ${displayAuthor}</p>
                        </div>
                        <div class="card-tags-wrapper">
                            ${r.tags.map(t => `<span class="badge">${t}</span>`).join('')}
                        </div>
                    </div>
                </div>`;
        });
        html += '</div>';
        app.innerHTML = html;
        releaseWakeLock();
    }

    // --- SHOW RECIPE (Restored Layout) ---
    function showRecipe(id, pushState = true) {
        const r = recipes.find(x => x.id === id);
        if (!r) return;
        currentRecipe = r;
        
        currentLang = activeTags.has('English') ? 'en' : 'he';
        
        if (pushState) {
            history.pushState({ recipeId: id }, '', `?recipe=${id}`);
            document.title = `${r.title} | ××ª×›×•× ×™× ××©×¤×—×ª×™×™×`;
        }
        renderRecipeDetail();
        window.scrollTo(0,0);
    }

    function toggleLang(lang) {
        // If specific language passed, use it, otherwise toggle
        if (lang) currentLang = lang;
        else currentLang = (currentLang === 'en') ? 'he' : 'en';
        
        renderRecipeDetail();
    }

    function renderRecipeDetail() {
        document.getElementById('edit-json-link').style.display = 'inline-flex';

        const r = currentRecipe;
        const isEn = currentLang === 'en';
        const data = isEn && r.english ? r.english : r;
        
        const imgSrc = r.image ? r.image : DEFAULT_IMAGE;
        let linkHTML = r.sourceUrl ? `<div style="margin-top:10px;"><a href="${r.sourceUrl}" target="_blank" style="color:var(--primary); font-weight:600; text-decoration:underline;">ğŸ”— ${isEn ? 'Link to original' : '×œ××¢×‘×¨ ×œ××ª×›×•×Ÿ ×”××§×•×¨×™'}</a></div>` : '';

        // Restored Icons (with Text)
        const bookmarkBtn = `
            <button class="heart-btn ${isBookmarked(r.id) ? 'hearted' : ''}" onclick="toggleBookmark('${r.id}')" title="${isBookmarked(r.id) ? (isEn ? 'Remove from favorites' : '×”×¡×¨×” ××”××•×¢×“×¤×™×') : (isEn ? 'Add to favorites' : '×”×•×¡×¤×” ×œ××•×¢×“×¤×™×')}">
                <svg viewBox="0 0 24 24">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </button>`;

        const shareBtn = `
            <button class="tag-btn" onclick="shareRecipe()" title="${isEn ? 'Share recipe link' : '×©×™×ª×•×£ ×§×™×©×•×¨ ×œ××ª×›×•×Ÿ'}">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                ${isEn ? 'Share' : '×©×™×ª×•×£'}
            </button>`;

        const wakeLockTitle = isEn ? "Prevent screen from turning off" : "××•× ×¢ ××”××¡×š ×œ×”×™×›×‘×•×ª ×‘×–××Ÿ ×”×‘×™×©×•×œ";
        const wakeLockBtn = `
            <button class="tag-btn" id="wakeLockBtn" onclick="toggleWakeLock()" title="${wakeLockTitle}">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8-11-8-11-8-11-8-11-8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                ${isEn ? 'Wake Lock' : '××¡×š ×¤×¢×™×œ'}
            </button>`;

        // MODIFIED: Click on the wrapper toggles language regardless of which part is clicked
        const langToggle = r.tags.includes('English') ? `
            <div style="background:var(--tag-bg); padding:3px; border-radius:20px; display:inline-flex; cursor:pointer;" onclick="toggleLang()">
                <button class="tag-btn ${!isEn ? 'active-tag' : ''}" style="border:none; padding:4px 12px; font-size:0.8rem; pointer-events:none;">×¢×‘×¨×™×ª</button>
                <button class="tag-btn ${isEn ? 'active-tag' : ''}" style="border:none; padding:4px 12px; font-size:0.8rem; pointer-events:none;">English</button>
            </div>` : '';

        // Changed inner div to use "nav-actions" class instead of inline style
        app.innerHTML = `
            <div class="recipe-detail ${isEn ? 'english-content' : ''}">
                <div class="recipe-nav">
                    <button class="tag-btn back-btn" onclick="navigateHome()">
                        <svg class="icon-svg" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 19 12 12 5"></polyline></svg>
                        ${isEn ? 'Back' : '×—×–×¨×”'}
                    </button>
                    
                    <div class="nav-actions">
                        ${langToggle}
                        ${shareBtn}
                        ${wakeLockBtn}
                    </div>
                </div>

                <div class="recipe-hero">
                    <img src="${imgSrc}" class="recipe-hero-image" alt="${data.title}">
                    ${bookmarkBtn}
                    <div class="recipe-header-content">
                        <h1>${data.title}</h1>
                        <p class="author">${isEn ? 'By' : '×××ª'}: ${data.author}</p>
                        ${linkHTML}
                    </div>
                </div>

                <div class="recipe-body-grid">
                    <aside class="ingredients-column">
                        ${data.ingredients && data.ingredients.length > 0 ? `
                        <div class="scaler">
                            <span style="align-self:center; font-size:0.9rem; color:var(--text-muted);">${isEn ? 'Scale' : '×›××•×™×•×ª'}:</span>
                            <button class="scale-btn" id="btn-0.5" onclick="renderIngredients(0.5)">0.5x</button>
                            <button class="scale-btn active" id="btn-1" onclick="renderIngredients(1)">1x</button>
                            <button class="scale-btn" id="btn-1.5" onclick="renderIngredients(1.5)">1.5x</button>
                            <button class="scale-btn" id="btn-2" onclick="renderIngredients(2)">2x</button>
                        </div>
                        <div id="ing-list" class="ingredients-list"></div>
                        ` : '<p>No ingredients listed.</p>'}
                    </aside>

                    <section class="instructions">
                        <h3>${isEn ? 'Instructions' : '×”×•×¨××•×ª ×”×›× ×”'}</h3>
                        <div style="font-size:1.1rem; line-height:1.8;">
                            ${formatInstructions(data.instructions)}
                        </div>
                    </section>
                </div>
                
                <!-- Recipe Notes Section -->
                <div id="notes-section-full" style="display: none; margin: 20px 20px 16px 20px; padding: 14px 16px; background: var(--column-bg); border-radius: 10px; border: 1px solid var(--border-color);">
                    <div class="notes-header">
                        <h3 style="margin: 0; color: var(--header-text); font-size: 1.05rem; white-space: nowrap;">×”×¢×¨×•×ª ××™×©×™×•×ª</h3>
                        <div class="notes-header-actions">
                            <button class="notes-edit-btn" onclick="toggleNotesEditor()" id="notes-edit-btn">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                ×¢×¨×™×›×”
                            </button>
                            <button class="notes-edit-btn" onclick="deleteRecipeNotes()" id="notes-delete-btn" style="display: none; color: #dc2626;">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                ××—×™×§×”
                            </button>
                        </div>
                    </div>
                    
                    <div id="notes-display" style="display: none; color: var(--text-main); padding: 10px; background: var(--input-bg); border-radius: 8px;"></div>
                    
                    <div id="notes-editor" style="display: none;">
                        <textarea id="notes-textarea" 
                                  style="width: 100%; min-height: 120px; padding: 12px; 
                                         border: 1px solid var(--border-color); border-radius: 8px;
                                         background: var(--input-bg); color: var(--text-main);
                                         font-family: inherit; font-size: 1rem; resize: vertical;"
                                  placeholder="× ×™×ª×Ÿ ×œ×›×ª×•×‘  ×‘×—×œ×•×Ÿ  ×–×” ×”×¢×¨×•×ª ×©×™×•×¦×’×• ×œ×š ×‘×œ×‘×“ (×˜×™×¤×™×, ×©×™× ×•×™×™ ×›××•×™×•×ª ×•×›×•')"></textarea>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="tag-btn" onclick="toggleNotesEditor()" style="background: var(--primary); color: white; border: none;">
                                ×©××™×¨×”
                            </button>
                            <button class="tag-btn" onclick="cancelNotesEditor()">
                                ×‘×™×˜×•×œ
                            </button>
                        </div>
                    </div>
                </div>
                <div id="notes-section-empty" style="display: none; margin: 16px 20px; text-align: center;">
                    <button class="notes-add-btn" onclick="openNotesFromEmpty()" title="×”×•×¡×¤×ª ×”×¢×¨×•×ª ×œ××ª×›×•×Ÿ ×–×” ×©×™×•×¦×’×• ×¨×§ ×œ×š">
                        <svg class="icon-svg" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        ×”×•×¡×¤×ª ×”×¢×¨×•×ª ××™×©×™×•×ª
                    </button>
                </div>
            </div>
        `;
        
        if(wakeLock && document.getElementById('wakeLockBtn')) {
             document.getElementById('wakeLockBtn').classList.add('active-tag');
        }
        
        // Load recipe notes
        const savedNotes = getRecipeNotes(currentRecipe.id);
        const notesFull = document.getElementById('notes-section-full');
        const notesEmpty = document.getElementById('notes-section-empty');
        const notesDisplay = document.getElementById('notes-display');
        const notesEditor = document.getElementById('notes-editor');
        const notesDeleteBtn = document.getElementById('notes-delete-btn');
        
        if (savedNotes) {
            notesDisplay.innerHTML = `<p style="white-space: pre-wrap; margin: 0;">${savedNotes}</p>`;
            notesDisplay.style.display = 'block';
            notesDeleteBtn.style.display = 'inline-flex';
            notesFull.style.display = 'block';
            notesEmpty.style.display = 'none';
        } else {
            notesFull.style.display = 'none';
            notesEmpty.style.display = 'block';
            notesDisplay.style.display = 'none';
        }
        notesEditor.style.display = 'none';

        if(data.ingredients && data.ingredients.length > 0) renderIngredients(1);
    }

    // --- WAKE LOCK ---
    async function toggleWakeLock() {
        const btn = document.getElementById('wakeLockBtn');
        if (!wakeLock) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => {
                    wakeLock = null;
                    if(btn) btn.classList.remove('active-tag');
                });
                if(btn) btn.classList.add('active-tag');
            } catch (err) {
                console.error(err);
                alert("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š");
            }
        } else {
            await wakeLock.release();
        }
    }
    function releaseWakeLock() { if (wakeLock) { wakeLock.release(); wakeLock = null; } }
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') await toggleWakeLock();
    });

    // --- SHARE ---
    async function shareRecipe() {
        if (!currentRecipe) return;
        if (navigator.share) {
            try { await navigator.share({ title: currentRecipe.title, text: `${currentRecipe.title}`, url: window.location.href }); } catch (err) {}
        } else {
            try { await navigator.clipboard.writeText(window.location.href); alert("×”×§×™×©×•×¨ ×”×•×¢×ª×§"); } catch (err) {}
        }
    }

    // --- FORMATTERS ---
    function formatInstructions(text) {
        if (!text) return '';
        const lines = text.split('\n').filter(line => line.trim() !== '');
        let html = '';
        let listType = null;
        lines.forEach(line => {
            line = line.trim();
            const orderedMatch = line.match(/^(\d+)[\.\)\-]\s+(.*)/);
            const unorderedMatch = line.match(/^[\-\*]\s+(.*)/);
            if (orderedMatch) {
                if (listType !== 'ol') { if (listType) html += `</${listType}>`; html += '<ol>'; listType = 'ol'; }
                html += `<li>${orderedMatch[2]}</li>`; 
            } else if (unorderedMatch) {
                if (listType !== 'ul') { if (listType) html += `</${listType}>`; html += '<ul>'; listType = 'ul'; }
                html += `<li>${unorderedMatch[1]}</li>`;
            } else {
                if (listType) { html += `</${listType}>`; listType = null; }
                html += `<p>${line}</p>`;
            }
        });
        if (listType) html += `</${listType}>`;
        return html;
    }

function formatAmount(amount) {
        if (typeof amount !== 'number') return amount;
        if (Number.isInteger(amount)) return amount;
        
        const epsilon = 0.05; 
        const decimal = amount % 1;
        const integer = Math.floor(amount);
        let fraction = '';
        
        if (Math.abs(decimal - 0.25) < epsilon) fraction = '1/4';
        else if (Math.abs(decimal - 0.33) < epsilon) fraction = '1/3';
        else if (Math.abs(decimal - 0.5) < epsilon) fraction = '1/2';
        else if (Math.abs(decimal - 0.66) < epsilon) fraction = '2/3';
        else if (Math.abs(decimal - 0.75) < epsilon) fraction = '3/4';
        
        if (fraction) {
            // Only switch to compact unicode if there is an integer (x > 1)
            // 1.5 becomes 1Â½ | 0.5 stays 1/2
            if (integer > 0) {
                const map = { '1/4': 'Â¼', '1/3': 'â…“', '1/2': 'Â½', '2/3': 'â…”', '3/4': 'Â¾' };
                return `${integer}${map[fraction]}`; 
            }
            return fraction;
        }
        
        return amount.toFixed(2).replace(/\.?0+$/, '');
    }

    function renderIngredients(mult) {
        document.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btn-${mult}`);
        if(btn) btn.classList.add('active');

        const isEn = currentLang === 'en';
        const data = isEn && currentRecipe.english ? currentRecipe.english : currentRecipe;
        
        let html = '<ul>';
        const processItems = (items) => {
            return items.map(item => {
                let rawVal = item.amount ? (item.amount * mult) : '';
                let displayVal = rawVal;
                let conversionText = '';
                
                // Determine Singular or Plural form
                let displayUnit = item.unit || '';
                let displayItem = item.item || '';

                if (typeof rawVal === 'number') {
                    const conv = getConversion(rawVal, item.unit, item.item, isEn ? 'en' : 'he');
                    if (conv) conversionText = `<span style="font-weight:normal; font-size:0.85em; color:var(--text-muted);">(${conv})</span>`;
                    displayVal = formatAmount(rawVal);
                    
                    // Pluralization Logic
                    if (typeof getPlural === 'function') {
                        displayUnit = getPlural(item.unit, rawVal);
                        displayItem = getPlural(item.item, rawVal);
                    }
                }

                const shouldShowBold = (displayVal !== '') || (displayUnit && displayUnit.trim().length > 0);
                const amountHTML = shouldShowBold 
                    ? `<strong><span style="direction:ltr; unicode-bidi:embed;">${displayVal}</span> ${displayUnit}</strong> `
                    : '';
                return `<li onclick="this.classList.toggle('checked')">
                    <span class="ing-content">
                        ${amountHTML}<span>${displayItem} ${conversionText}</span>
                    </span>
                </li>`;
            }).join('');
        };
        data.ingredients.forEach(entry => {
            if (entry.sectionName) { html += `</ul><h4 class="ing-section-title">${entry.sectionName}</h4><ul>`; html += processItems(entry.items); } 
            else if (entry.amount !== undefined) { html += processItems([entry]); }
        });
        html += '</ul>';
        const container = document.getElementById('ing-list');
        if(container) container.innerHTML = html;
    }

    // --- SEARCH & FILTER ---
    function filterByTag(tag) {
        if (tag === '') {
            activeTags.clear();
            // Also clear bookmarks when clicking "×”×›×œ"
            if (showingOnlyBookmarks) {
                showingOnlyBookmarks = false;
                const bookmarkBtn = document.getElementById('bookmarks-filter-btn');
                if (bookmarkBtn) bookmarkBtn.classList.remove('active-tag');
            }
        }
        else {
            if (activeTags.has(tag)) activeTags.delete(tag);
            else activeTags.add(tag);
        }
        
        updateFilterUI();
        runFilterAndShow();
    }

    function updateFilterUI() {
        document.querySelectorAll('.tag-btn').forEach(btn => {
            const btnId = btn.id;
            if (btnId === 'tag-all') {
                if (activeTags.size === 0 && !showingOnlyBookmarks) btn.classList.add('active-tag');
                else btn.classList.remove('active-tag');
            } else if (btnId === 'bookmarks-filter-btn') {
                // Bookmark button handled below
            } else {
                const tagName = btnId.replace('tag-', '');
                if (activeTags.has(tagName)) btn.classList.add('active-tag');
                else btn.classList.remove('active-tag');
            }
        });
        
        // Update bookmark button state
        const bookmarkBtn = document.getElementById('bookmarks-filter-btn');
        if (bookmarkBtn) {
            if (showingOnlyBookmarks) bookmarkBtn.classList.add('active-tag');
            else bookmarkBtn.classList.remove('active-tag');
        }
        
        const searchBox = document.querySelector('.search-box');
        if (activeTags.has('English')) {
            searchBox.placeholder = "Search recipes, ingredients, authors...";
            searchBox.style.direction = "ltr";
        } else {
            searchBox.placeholder = "×—×™×¤×•×© ××ª×›×•×Ÿ, ×›×•×ª×‘, ×ª×’×™×ª, ××• ××¨×›×™×‘...";
            searchBox.style.direction = "rtl";
        }
    }


    function applyFiltersAndSort() {
        const searchVal = document.querySelector('.search-box').value;
        runFilterAndShow(searchVal);
    }
    function searchRecipes(q) { runFilterAndShow(q); }

function runFilterAndShow(searchTerm = '') {
        const rawTerms = searchTerm.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
        const isEnglishMode = activeTags.has('English');
        
        // Helper: Returns true if ALL search tokens are found in the text
        const hasMatch = (text) => {
            if (!text) return false;
            const lowerText = text.toLowerCase();
            // Every token typed by the user must exist in the text
            return rawTerms.every(term => {
                // Check the term itself OR its plural/singular forms from dictionary
                let variations = [term];
                if (typeof WORD_FORMS !== 'undefined' && WORD_FORMS[term]) {
                    const entry = WORD_FORMS[term];
                    variations.push(entry.s, entry.p);
                }
                return variations.some(v => lowerText.includes(v));
            });
        };

        // -------------------------------

        let filtered = recipes.filter(r => {
            // 1. Bookmark Filter
            if (showingOnlyBookmarks) {
                if (!isBookmarked(r.id)) return false;
            }

            // 2. Tag Filter
            if (activeTags.size > 0) {
                for (let tag of activeTags) { if (!r.tags.includes(tag)) return false; }
            }
            
            // 3. Search Filter (if empty, show all)
            if (rawTerms.length === 0) return true;

            if (isEnglishMode) {
                if (!r.english) return false;
                const title = r.english.title || '';
                const author = r.english.author || '';
                
                // Check Ingredients using the new helper
                const ing = r.english.ingredients.some(entry => {
                    if (entry.items) return entry.items.some(sub => hasMatch(sub.item));
                    return entry.item && hasMatch(entry.item);
                });
                
                return hasMatch(title) || hasMatch(author) || ing;

            } else {
                // Hebrew Logic
                const inTitle = hasMatch(r.title);
                // Check tags too (so searching "×—×œ×‘×™" works)
                const inTags = r.tags.some(t => hasMatch(t));
                const inAuthor = r.author && hasMatch(r.author);
                
                const inIngredients = r.ingredients.some(entry => {
                    if (entry.items) return entry.items.some(sub => hasMatch(sub.item));
                    return entry.item && hasMatch(entry.item);
                });

                return inTitle || inTags || inIngredients || inAuthor;
            }
        });

        // --- SORTING ---
        if (currentSort === 'az') {
            filtered.sort((a, b) => {
                const titleA = (isEnglishMode && a.english) ? a.english.title : a.title;
                const titleB = (isEnglishMode && b.english) ? b.english.title : b.title;
                return titleA.trim().localeCompare(titleB.trim(), isEnglishMode ? 'en' : 'he');
            });
        } else if (currentSort === 'za') {
            filtered.sort((a, b) => {
                const titleA = (isEnglishMode && a.english) ? a.english.title : a.title;
                const titleB = (isEnglishMode && b.english) ? b.english.title : b.title;
                return titleB.trim().localeCompare(titleA.trim(), isEnglishMode ? 'en' : 'he');
            });
        } else if (currentSort === 'newest') {
             filtered.reverse();
        }

        showList(filtered, false);
    }

    function sendDraft() {
        const t = document.getElementById('draft-title').value;
        const b = document.getElementById('draft-body').value;
        const selectedTags = Array.from(document.querySelectorAll('.draft-tag:checked')).map(cb => cb.value).join(', ');
        const subject = `××ª×›×•×Ÿ ×—×“×©: ${t}`;
        const body = `×©×: ${t}\n×ª×’×™×•×ª: ${selectedTags}\n\n${b}\n\n[× × ×œ×¦×¨×£ ×ª××•× ×” ××• ×§×•×‘×¥ ×× ×™×©]`;
        window.location.href = `mailto:shohamofek@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    // --- GENERATOR LOGIC (UPDATED) ---
    function toggleModal(show) {
        document.getElementById('adminModal').style.display = show ? 'flex' : 'none';
        if(show && document.getElementById('gen-ing-rows').children.length === 0) addIngRow(); 
    }
    
    // NEW: Open Generator and clear fields
    function openGenerator() {
        // Clear all fields
        document.getElementById('gen-id').value = '';
        document.getElementById('gen-title').value = '';
        document.getElementById('gen-author').value = '';
        document.getElementById('gen-image').value = '';
        document.getElementById('gen-url').value = '';
        document.getElementById('gen-inst').value = '';
        document.getElementById('gen-output').value = '';
        
        // Reset tags
        document.querySelectorAll('.gen-tag-input').forEach(cb => { cb.checked = false; });
        
        // Reset ingredients to one empty row
        const rowsContainer = document.getElementById('gen-ing-rows');
        rowsContainer.innerHTML = '';
        addIngRow();
        
        toggleModal(true);
    }

    // UPDATED: Controls for rows
    function getRowControlsHTML() {
        return `
            <div class="gen-row-controls">
                <button class="gen-icon-btn" onclick="moveRow(this, -1)" title="×œ××¢×œ×”">
                    <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"></polyline></svg>
                </button>
                <button class="gen-icon-btn" onclick="moveRow(this, 1)" title="×œ××˜×”">
                    <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <button class="gen-icon-btn delete-btn" onclick="this.closest('.ing-row').remove()" title="××—×™×§×”">
                    <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        `;
    }

    function addIngRow(itemData = null) {
        const div = document.createElement('div'); div.className = 'ing-row';
        let valAmount = '', valUnit = '', valItem = '';
        if (itemData) { valAmount = itemData.amount !== null ? itemData.amount : ''; valUnit = itemData.unit || ''; valItem = itemData.item || ''; }
        
        div.innerHTML = `
            <input type="text" class="gen-input gen-amount" placeholder="×›××•×ª" value="${valAmount}" style="margin:0;">
            <input type="text" class="gen-input gen-unit" placeholder="×™×—'" value="${valUnit}" style="margin:0;">
            <input type="text" class="gen-input gen-item" placeholder="××•×¦×¨" value="${valItem}" style="margin:0;">
            ${getRowControlsHTML()}
        `;
        document.getElementById('gen-ing-rows').appendChild(div);
    }

    function addSectionRow(name = '') {
        const div = document.createElement('div'); 
        div.className = 'ing-row'; 
        // Force flex for section rows to span correctly in grid container
        div.style.display = "flex"; 
        
        div.innerHTML = `
            <input type="text" class="gen-section-name gen-input" style="flex:1; background:#e0ffe0; border-color:#81e6d9; margin:0;" placeholder="×›×•×ª×¨×ª ××©× ×”" value="${name}">
            ${getRowControlsHTML()}
        `;
        document.getElementById('gen-ing-rows').appendChild(div);
    }

    function moveRow(btn, direction) {
        const row = btn.closest('.ing-row');
        const container = row.parentElement;
        
        if (direction === -1) { // Up
            const prev = row.previousElementSibling;
            if (prev) container.insertBefore(row, prev);
        } else { // Down
            const next = row.nextElementSibling;
            if (next) container.insertBefore(next, row);
        }
    }

    function loadRecipeToEdit() {
        if(!currentRecipe) return;
        const r = currentRecipe;
        document.getElementById('gen-id').value = r.id;
        document.getElementById('gen-title').value = r.title;
        document.getElementById('gen-author').value = r.author;
        document.getElementById('gen-image').value = r.image;
        document.getElementById('gen-url').value = r.sourceUrl || '';
        document.getElementById('gen-inst').value = r.instructions; 
        document.querySelectorAll('.gen-tag-input').forEach(cb => { cb.checked = r.tags.includes(cb.value); });
        const rowsContainer = document.getElementById('gen-ing-rows');
        rowsContainer.innerHTML = ''; 
        r.ingredients.forEach(entry => {
            if(entry.sectionName) { addSectionRow(entry.sectionName); if(entry.items) entry.items.forEach(subItem => addIngRow(subItem)); } 
            else if (entry.items) { entry.items.forEach(subItem => addIngRow(subItem)); } else { addIngRow(entry); }
        });
        toggleModal(true);
    }
    function wrapText(tag) {
        const textarea = document.getElementById('gen-inst');
        const start = textarea.selectionStart; const end = textarea.selectionEnd; const text = textarea.value;
        if (start === end) return; 
        textarea.value = text.substring(0, start) + `<${tag}>` + text.substring(start, end) + `</${tag}>` + text.substring(end);
    }
    function parseAmount(val) {
        if (!val) return null; val = String(val).trim();
        try { const parts = val.split(' '); let total = 0; for (let part of parts) { if (part.includes('/')) { const [num, den] = part.split('/'); if (den && parseFloat(den) !== 0) total += parseFloat(num) / parseFloat(den); } else { total += parseFloat(part); } } return isNaN(total) ? null : total; } catch (e) { return null; }
    }
    function generateCode() {
        const id = document.getElementById('gen-id').value; const title = document.getElementById('gen-title').value; const author = document.getElementById('gen-author').value; let image = document.getElementById('gen-image').value.trim(); const url = document.getElementById('gen-url').value; const inst = document.getElementById('gen-inst').value;
        if (image && !image.startsWith('http') && !image.startsWith('images/')) image = 'images/' + image;
        const tags = Array.from(document.querySelectorAll('.gen-tag-input:checked')).map(cb => cb.value);
        const rowsContainer = document.getElementById('gen-ing-rows');
        let finalIngredients = []; let currentSection = null;
        Array.from(rowsContainer.children).forEach(row => {
            if (row.querySelector('.gen-section-name')) { const name = row.querySelector('.gen-section-name').value; if (name) { currentSection = { sectionName: name, items: [] }; finalIngredients.push(currentSection); } } 
            else if (row.classList.contains('ing-row')) { const amountStr = row.querySelector('.gen-amount').value; const unit = row.querySelector('.gen-unit').value; const item = row.querySelector('.gen-item').value; const amountVal = parseAmount(amountStr); if (item) { const ingObj = { amount: amountVal, unit: unit, item: item }; if (currentSection) { currentSection.items.push(ingObj); } else { finalIngredients.push(ingObj); } } }
        });
        const obj = { id: id || "new-id", title: title, author: author, tags: tags, image: image, sourceUrl: url, ingredients: finalIngredients, instructions: inst };
        const json = JSON.stringify(obj, null, 4); document.getElementById('gen-output').value = json.replace(/"([^"]+)":/g, '$1:') + ",";
    }
    async function processImages() {
        const files = document.getElementById('opt-files').files;
        if (files.length === 0) { alert('× × ×œ×‘×—×•×¨ ×§×‘×¦×™×'); return; }
        const status = document.getElementById('opt-status');
        const maxWidth = 400; let count = 0; status.innerHTML = '××¢×‘×“ ×ª××•× ×•×ª...';
        for (let file of files) {
            try {
                if (!file.type.startsWith('image/')) continue;
                const bitmap = await createImageBitmap(file);
                const scale = maxWidth / bitmap.width;
                const newHeight = bitmap.height * scale;
                const canvas = document.createElement('canvas');
                canvas.width = maxWidth; canvas.height = newHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(bitmap, 0, 0, maxWidth, newHeight);
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                const originalName = file.name; const dotIndex = originalName.lastIndexOf('.'); const namePart = dotIndex !== -1 ? originalName.substring(0, dotIndex) : originalName; const newName = `${namePart}_thumb.jpg`;
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = newName; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                count++; status.innerHTML = `×”×•×¨×“: ${count}/${files.length}`; await new Promise(r => setTimeout(r, 200));
            } catch (e) { console.error(e); status.innerHTML += `<br>×©×’×™××” ×‘×§×•×‘×¥ ${file.name}`; }
        }
        status.innerHTML = `×¡×™×•×! ${count} ×ª××•× ×•×ª ×”×•×¨×“×•.`;
    }

    // =============================================
    // --- INLINE EDIT MODE ---
    // =============================================
    let isEditMode = false;
    let editQuill = null;
    let editTags = new Set();
    let isNewRecipe = false;

    function startNewRecipe() {
        const newRecipe = {
            id: '',
            title: '',
            author: '',
            tags: [],
            image: '',
            sourceUrl: '',
            ingredients: [{ sectionName: '', items: [{ amount: null, unit: '', item: '' }] }],
            instructions: ''
        };
        currentRecipe = newRecipe;
        isNewRecipe = true;
        history.pushState({ recipeId: 'new' }, '', '?recipe=new');
        document.title = '××ª×›×•×Ÿ ×—×“×© | ××ª×›×•× ×™× ××©×¤×—×ª×™×™×';
        enterEditMode();
    }

    function enterEditMode() {
        if (!currentRecipe) return;
        isEditMode = true;
        editTags = new Set(currentRecipe.tags || []);
        renderEditMode();
        window.scrollTo(0, 0);
    }

    function exitEditMode() {
        isEditMode = false;
        if (editQuill) { editQuill = null; }
        if (isNewRecipe) {
            isNewRecipe = false;
            navigateHome();
        } else {
            renderRecipeDetail();
        }
    }

    function renderEditMode() {
        document.getElementById('edit-json-link').style.display = 'none';
        const r = currentRecipe;
        const imgSrc = r.image || '';

        // Build tag chips
        const tagChips = AVAILABLE_TAGS.filter(t => t !== 'English').map(t => {
            const sel = editTags.has(t) ? 'selected' : '';
            return `<button type="button" class="edit-tag-chip ${sel}" onclick="toggleEditTag('${t}', this)">${t}</button>`;
        }).join('');

        // Build ingredient sections
        let ingHTML = '';
        if (r.ingredients && r.ingredients.length > 0) {
            r.ingredients.forEach((entry, si) => {
                if (entry.sectionName !== undefined) {
                    ingHTML += buildEditSection(entry.sectionName, entry.items || [], si);
                } else if (entry.items) {
                    ingHTML += buildEditSection('', entry.items, si);
                }
            });
        }
        if (!ingHTML) {
            ingHTML = buildEditSection('', [{ amount: null, unit: '', item: '' }], 0);
        }

        // Convert existing instructions to HTML for Quill
        // Smart conversion: detect numbered/bulleted lines and wrap in proper <ol>/<ul>
        let instructionsHTML = '';
        if (r.instructions) {
            instructionsHTML = instructionsToQuillHTML(r.instructions);
        }

        app.innerHTML = `
            <div class="recipe-detail edit-mode-active">
                <div class="recipe-nav">
                    <button class="tag-btn" onclick="exitEditMode()">
                        <svg class="icon-svg" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        ×‘×™×˜×•×œ
                    </button>
                    <div class="edit-mode-badge">××¦×‘ ×¢×¨×™×›×”</div>
                </div>

                <!-- Title -->
                <div class="edit-field-group">
                    <input type="text" class="edit-title-input" id="edit-title" value="${escapeAttr(r.title)}" placeholder="×©× ×”××ª×›×•×Ÿ">
                </div>

                <!-- Author + ID -->
                <div class="edit-row-2">
                    <div class="edit-field-group">
                        <label class="edit-label">××—×‘×¨/×ª</label>
                        <input type="text" class="edit-input" id="edit-author" value="${escapeAttr(r.author)}" placeholder="×©×">
                    </div>
                    <div class="edit-field-group">
                        <label class="edit-label">××–×”×” (ID)</label>
                        <input type="text" class="edit-input" id="edit-id" value="${escapeAttr(r.id)}" placeholder="english-no-spaces" dir="ltr">
                    </div>
                </div>

                <!-- Tags -->
                <div class="edit-field-group">
                    <label class="edit-label">×ª×’×™×•×ª</label>
                    <div class="edit-tags-grid">${tagChips}</div>
                </div>

                <!-- Image -->
                <div class="edit-field-group">
                    <label class="edit-label">×ª××•× ×”</label>
                    <div class="edit-image-section">
                        <div class="edit-image-inputs">
                            <div class="edit-image-upload-row">
                                <label class="edit-upload-btn" for="edit-image-file">
                                    <svg class="icon-svg" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                    ×‘×—×™×¨×ª ×ª××•× ×”
                                </label>
                                <input type="file" id="edit-image-file" accept="image/*" style="display:none;" onchange="handleEditImageUpload(this)">
                                <span class="edit-image-filename" id="edit-image-filename"></span>
                            </div>
                            <div class="edit-image-or">××•</div>
                            <input type="text" class="edit-input" id="edit-image" value="${escapeAttr(imgSrc)}" placeholder="×§×™×©×•×¨ ×œ×ª××•× ×” ××• ×©× ×§×•×‘×¥ (cake.jpg)" oninput="updateEditImagePreview()" style="margin:0;">
                        </div>
                        <div id="edit-img-preview" class="edit-img-preview-box">
                            ${imgSrc ? `<img src="${escapeAttr(imgSrc)}" class="edit-img-thumb" onerror="this.style.display='none'">` : ''}
                        </div>
                    </div>
                    <div id="edit-image-status" class="edit-image-status"></div>
                </div>

                <!-- Source URL -->
                <div class="edit-field-group">
                    <label class="edit-label">×§×™×©×•×¨ ×œ××§×•×¨ (××•×¤×¦×™×•× ×œ×™)</label>
                    <input type="text" class="edit-input" id="edit-url" value="${escapeAttr(r.sourceUrl || '')}" placeholder="https://..." dir="ltr">
                </div>

                <hr class="edit-divider">

                <!-- Ingredients -->
                <div class="edit-field-group">
                    <label class="edit-label">××¦×¨×›×™×</label>
                    <div id="edit-ingredients">${ingHTML}</div>
                    <button class="edit-add-section-btn" onclick="addEditSection()">+ ×§×‘×•×¦×” ×—×“×©×”</button>
                </div>

                <hr class="edit-divider">

                <!-- Instructions (Quill) -->
                <div class="edit-field-group">
                    <label class="edit-label">×”×•×¨××•×ª ×”×›× ×”</label>
                    <div id="edit-instructions-editor">${instructionsHTML}</div>
                </div>
            </div>

            <!-- Floating action bar -->
            <div class="edit-action-bar">
                <button class="edit-action-btn secondary" onclick="exitEditMode()">×‘×™×˜×•×œ</button>
                <button class="edit-action-btn secondary" onclick="exportEditJSON()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                    ×”×¢×ª×§ ×§×•×“
                </button>
                <button class="edit-action-btn primary" onclick="saveEditRecipe()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    ×©××™×¨×”
                </button>
            </div>
        `;

        // Initialize Quill
        initEditQuill();
    }

    function initEditQuill() {
        editQuill = new Quill('#edit-instructions-editor', {
            theme: 'snow',
            placeholder: '×›×ª×‘×• ×›××Ÿ ××ª ×”×•×¨××•×ª ×”×”×›× ×”...',
            modules: {
                toolbar: [
                    ['bold', 'underline'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });
        editQuill.format('direction', 'rtl');
        editQuill.format('align', 'right');
    }

    // --- Edit mode helpers ---
    function escapeAttr(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function instructionsToQuillHTML(text) {
        // Convert recipe instructions to Quill-compatible HTML.
        // Detects numbered lines (1. / 1) / 1-) and bullet lines (* / -) 
        // and wraps them in proper <ol>/<ul> so Quill doesn't double-number.
        if (!text) return '';
        
        // Normalize <b> to <strong> for Quill
        text = text.replace(/<b>/g, '<strong>').replace(/<\/b>/g, '</strong>');
        
        const lines = text.split('\n');
        let html = '';
        let listType = null; // 'ol' or 'ul' or null
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) {
                // Empty line â€” close any open list, add empty paragraph
                if (listType) { html += `</${listType}>`; listType = null; }
                html += '<p><br></p>';
                continue;
            }
            
            // Check for ordered list: "1." or "1)" or "1-" followed by space
            const orderedMatch = line.match(/^(\d+)[\.\)\-]\s+(.*)/);
            // Check for unordered list: "- " or "* "
            const unorderedMatch = line.match(/^[\-\*]\s+(.*)/);
            
            if (orderedMatch) {
                if (listType !== 'ol') {
                    if (listType) html += `</${listType}>`;
                    html += '<ol>';
                    listType = 'ol';
                }
                html += `<li>${orderedMatch[2]}</li>`;
            } else if (unorderedMatch) {
                if (listType !== 'ul') {
                    if (listType) html += `</${listType}>`;
                    html += '<ul>';
                    listType = 'ul';
                }
                html += `<li>${unorderedMatch[1]}</li>`;
            } else {
                // Regular paragraph
                if (listType) { html += `</${listType}>`; listType = null; }
                html += `<p>${line}</p>`;
            }
        }
        
        if (listType) html += `</${listType}>`;
        return html;
    }

    function toggleEditTag(tag, btn) {
        if (editTags.has(tag)) {
            editTags.delete(tag);
            btn.classList.remove('selected');
        } else {
            editTags.add(tag);
            btn.classList.add('selected');
        }
    }

    function updateEditImagePreview() {
        const url = document.getElementById('edit-image').value.trim();
        const container = document.getElementById('edit-img-preview');
        if (url) {
            const src = (!url.startsWith('http') && !url.startsWith('images/')) ? 'images/' + url : url;
            container.innerHTML = `<img src="${escapeAttr(src)}" class="edit-img-thumb" onerror="this.style.display='none'">`;
        } else {
            container.innerHTML = '';
        }
    }

    // --- Image upload with auto-thumbnail ---
    async function handleEditImageUpload(input) {
        const file = input.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        
        const status = document.getElementById('edit-image-status');
        const filenameDisplay = document.getElementById('edit-image-filename');
        const container = document.getElementById('edit-img-preview');
        
        filenameDisplay.textContent = file.name;
        status.textContent = '××¢×‘×“ ×ª××•× ×”...';
        
        try {
            const bitmap = await createImageBitmap(file);
            
            // Generate full-size (max 1200px wide)
            const fullMaxW = 1200;
            const fullScale = Math.min(1, fullMaxW / bitmap.width);
            const fullW = Math.round(bitmap.width * fullScale);
            const fullH = Math.round(bitmap.height * fullScale);
            const fullCanvas = document.createElement('canvas');
            fullCanvas.width = fullW; fullCanvas.height = fullH;
            fullCanvas.getContext('2d').drawImage(bitmap, 0, 0, fullW, fullH);
            const fullBlob = await new Promise(r => fullCanvas.toBlob(r, 'image/jpeg', 0.85));
            
            // Generate thumbnail (400px wide)
            const thumbMaxW = 400;
            const thumbScale = thumbMaxW / bitmap.width;
            const thumbW = thumbMaxW;
            const thumbH = Math.round(bitmap.height * thumbScale);
            const thumbCanvas = document.createElement('canvas');
            thumbCanvas.width = thumbW; thumbCanvas.height = thumbH;
            thumbCanvas.getContext('2d').drawImage(bitmap, 0, 0, thumbW, thumbH);
            const thumbBlob = await new Promise(r => thumbCanvas.toBlob(r, 'image/jpeg', 0.8));
            
            // Build filenames
            const dotIdx = file.name.lastIndexOf('.');
            const baseName = dotIdx !== -1 ? file.name.substring(0, dotIdx) : file.name;
            const fullName = `${baseName}.jpg`;
            const thumbName = `${baseName}_thumb.jpg`;
            
            // Auto-download both
            downloadBlob(fullBlob, fullName);
            await new Promise(r => setTimeout(r, 300));
            downloadBlob(thumbBlob, thumbName);
            
            // Set the image field to the expected path
            document.getElementById('edit-image').value = `images/${fullName}`;
            
            // Show preview from the generated blob
            const previewUrl = URL.createObjectURL(fullBlob);
            container.innerHTML = `<img src="${previewUrl}" class="edit-img-thumb">`;
            
            status.innerHTML = `<span style="color:var(--primary);">âœ“</span> ×”×•×¨×“×•: ${fullName} + ${thumbName}`;
            
        } catch (e) {
            console.error(e);
            status.innerHTML = `<span style="color:var(--danger-color);">×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª××•× ×”</span>`;
        }
    }

    function downloadBlob(blob, filename) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- Ingredient editing ---
    function buildEditSection(name, items, index) {
        let itemsHTML = '';
        if (items && items.length > 0) {
            items.forEach(item => {
                itemsHTML += buildEditIngRow(item);
            });
        }
        return `
        <div class="edit-section-block">
            <div class="edit-section-header">
                <input type="text" class="edit-section-name" value="${escapeAttr(name)}" placeholder="×©× ×§×‘×•×¦×” (×œ××©×œ: ×œ×‘×¦×§)">
                <button class="edit-icon-btn delete" onclick="this.closest('.edit-section-block').remove()" title="××—×§ ×§×‘×•×¦×”">
                    <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
            <div class="edit-ing-items">${itemsHTML}</div>
            <button class="edit-add-ing-btn" onclick="addEditIngRow(this.previousElementSibling)">+ ××¨×›×™×‘</button>
        </div>`;
    }

    function buildEditIngRow(item) {
        const amt = (item && item.amount !== null && item.amount !== undefined) ? item.amount : '';
        const unit = (item && item.unit) || '';
        const name = (item && item.item) || '';
        return `
        <div class="edit-ing-row">
            <input type="text" class="edit-ing-amount" value="${amt}" placeholder="×›××•×ª">
            <input type="text" class="edit-ing-unit" value="${escapeAttr(unit)}" placeholder="×™×—×™×“×”">
            <input type="text" class="edit-ing-name" value="${escapeAttr(name)}" placeholder="××•×¦×¨">
            <div class="edit-ing-controls">
                <button class="edit-icon-btn" onclick="moveEditRow(this, -1)" title="×œ××¢×œ×”">
                    <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"></polyline></svg>
                </button>
                <button class="edit-icon-btn" onclick="moveEditRow(this, 1)" title="×œ××˜×”">
                    <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <button class="edit-icon-btn delete" onclick="this.closest('.edit-ing-row').remove()" title="××—×™×§×”">
                    <svg class="icon-svg" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>`;
    }

    function addEditIngRow(container) {
        const row = document.createElement('div');
        row.className = 'edit-ing-row';
        row.innerHTML = `
            <input type="text" class="edit-ing-amount" value="" placeholder="×›××•×ª">
            <input type="text" class="edit-ing-unit" value="" placeholder="×™×—×™×“×”">
            <input type="text" class="edit-ing-name" value="" placeholder="××•×¦×¨">
            <div class="edit-ing-controls">
                <button class="edit-icon-btn" onclick="moveEditRow(this, -1)" title="×œ××¢×œ×”">
                    <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"></polyline></svg>
                </button>
                <button class="edit-icon-btn" onclick="moveEditRow(this, 1)" title="×œ××˜×”">
                    <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <button class="edit-icon-btn delete" onclick="this.closest('.edit-ing-row').remove()" title="××—×™×§×”">
                    <svg class="icon-svg" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        `;
        container.appendChild(row);
        row.querySelector('.edit-ing-amount').focus();
    }

    function addEditSection() {
        const container = document.getElementById('edit-ingredients');
        const section = document.createElement('div');
        section.innerHTML = buildEditSection('', [{ amount: null, unit: '', item: '' }], 0);
        container.appendChild(section.firstElementChild);
    }

    function moveEditRow(btn, direction) {
        const row = btn.closest('.edit-ing-row');
        const container = row.parentElement;
        if (direction === -1) {
            const prev = row.previousElementSibling;
            if (prev) container.insertBefore(row, prev);
        } else {
            const next = row.nextElementSibling;
            if (next) container.insertBefore(next, row);
        }
    }

    // --- Collect edit data ---
    function collectEditData() {
        const id = document.getElementById('edit-id').value.trim() || 'new-id';
        const title = document.getElementById('edit-title').value.trim();
        const author = document.getElementById('edit-author').value.trim();
        let image = document.getElementById('edit-image').value.trim();
        const sourceUrl = document.getElementById('edit-url').value.trim();
        
        if (image && !image.startsWith('http') && !image.startsWith('images/')) {
            image = 'images/' + image;
        }

        const tags = [...editTags];

        // Collect ingredients
        const ingredients = [];
        document.querySelectorAll('.edit-section-block').forEach(section => {
            const sectionName = section.querySelector('.edit-section-name').value.trim();
            const items = [];
            section.querySelectorAll('.edit-ing-row').forEach(row => {
                const amtStr = row.querySelector('.edit-ing-amount').value.trim();
                const unit = row.querySelector('.edit-ing-unit').value.trim();
                const item = row.querySelector('.edit-ing-name').value.trim();
                if (item) {
                    items.push({ amount: parseAmount(amtStr), unit, item });
                }
            });
            if (sectionName || items.length > 0) {
                ingredients.push({ sectionName: sectionName, items });
            }
        });

        // Get instructions from Quill â€” convert back to simple format
        let instructions = '';
        if (editQuill) {
            const html = editQuill.root.innerHTML;
            instructions = quillHTMLToSimple(html);
        }

        return { id, title, author, tags, image, sourceUrl, ingredients, instructions };
    }

    function quillHTMLToSimple(html) {
        // Convert Quill's HTML back to the simple format used in recipes.js
        let text = html;
        // Convert <strong> to <b>
        text = text.replace(/<strong>/g, '<b>').replace(/<\/strong>/g, '</b>');
        // Convert <em> to nothing (not used in current recipes, strip it)
        text = text.replace(/<em>/g, '').replace(/<\/em>/g, '');
        // Convert <p> and <br> to newlines
        text = text.replace(/<br\s*\/?>/g, '\n');
        text = text.replace(/<\/p>\s*<p[^>]*>/g, '\n\n');
        text = text.replace(/<p[^>]*>/g, '').replace(/<\/p>/g, '');
        // Convert ordered list items (reset counter per <ol>)
        text = text.replace(/<ol>/g, '%%OL_START%%').replace(/<\/ol>/g, '%%OL_END%%');
        // Convert unordered list items
        text = text.replace(/<ul>/g, '%%UL_START%%').replace(/<\/ul>/g, '%%UL_END%%');
        
        // Process: split by markers and rebuild
        let result = '';
        let inOl = false, inUl = false, olCounter = 0;
        const parts = text.split(/(%%OL_START%%|%%OL_END%%|%%UL_START%%|%%UL_END%%)/);
        for (const part of parts) {
            if (part === '%%OL_START%%') { inOl = true; olCounter = 0; continue; }
            if (part === '%%OL_END%%') { inOl = false; continue; }
            if (part === '%%UL_START%%') { inUl = true; continue; }
            if (part === '%%UL_END%%') { inUl = false; continue; }
            
            if (inOl) {
                result += part.replace(/<li[^>]*>/g, () => { olCounter++; return olCounter + '. '; })
                              .replace(/<\/li>/g, '\n');
            } else if (inUl) {
                result += part.replace(/<li[^>]*>/g, '- ').replace(/<\/li>/g, '\n');
            } else {
                result += part;
            }
        }
        text = result;
        // Strip remaining HTML tags
        text = text.replace(/<[^>]+>/g, '');
        // Decode entities
        text = text.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
        // Clean up extra whitespace
        text = text.replace(/\n{3,}/g, '\n\n').trim();
        return text;
    }

    function exportEditJSON() {
        const obj = collectEditData();
        const json = JSON.stringify(obj, null, 4).replace(/"([^"]+)":/g, '$1:') + ',';
        navigator.clipboard.writeText(json).then(() => {
            showEditToast('×”×§×•×“ ×”×•×¢×ª×§ ×œ×œ×•×—!');
        }).catch(() => {
            prompt('×”×¢×ª×§:', json);
        });
    }

    function saveEditRecipe() {
        const obj = collectEditData();
        if (!obj.title) {
            showEditToast('×—×¡×¨ ×©× ×œ××ª×›×•×Ÿ');
            return;
        }
        const json = JSON.stringify(obj, null, 4).replace(/"([^"]+)":/g, '$1:') + ',';
        navigator.clipboard.writeText(json).then(() => {
            showEditToast('×”××ª×›×•×Ÿ × ×©××¨! (×”×•×¢×ª×§ ×œ×œ×•×—)');
        }).catch(() => {
            prompt('×”×¢×ª×§:', json);
        });
    }

    function showEditToast(msg) {
        let toast = document.getElementById('edit-toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'edit-toast';
            toast.className = 'edit-toast';
            document.body.appendChild(toast);
        }
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.js"></script>
</body>
</html>